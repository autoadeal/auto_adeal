{% extends "base.html" %}

{% block title %}Pagesa - Auto Adeal{% endblock %}

{% block description %}Perfundo blerjen tende. Pagese ne dorezim, dergese ne te gjithe Shqiperine dhe Kosoven{% endblock %}

{% block canonical %}https://autoadeal.com/checkout{% endblock %}

{% block content %}
<div class="container mx-auto px-4 md:px-6 py-8">
    <h1 class="text-3xl font-bold text-black mb-6">Pagesa</h1>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
            <h3 class="font-bold text-lg text-black mb-4">Informacioni i Dërgesës</h3>
            <form id="checkout-form" onsubmit="processOrder(event)" class="space-y-4">
                <input type="text" id="checkout-name" placeholder="Emri i Plote" required class="w-full px-4 py-2 border border-gray-300 rounded text-black">
                <input type="email" id="checkout-email" placeholder="Email (opsionale)" class="w-full px-4 py-2 border border-gray-300 rounded text-black">
                <input type="tel" id="checkout-phone" placeholder="Numri i telefonit" required class="w-full px-4 py-2 border border-gray-300 rounded text-black">
                <select id="checkout-country" onchange="updateShipping()" required class="w-full px-4 py-2 border border-gray-300 rounded text-black">
                    <option value="">Zgjidh Shtetin</option>
                    <option value="Albania">Shqiperi</option>
                    <option value="Kosovo">Kosove</option>
                </select>
                <input type="text" id="checkout-address" placeholder="Adresa (Rruga, Numri)" required class="w-full px-4 py-2 border border-gray-300 rounded text-black">
                <input type="text" id="checkout-city" placeholder="Qyteti" required class="w-full px-4 py-2 border border-gray-300 rounded text-black">
                <button type="submit" class="w-full bg-red-600 text-white py-3 rounded hover:bg-red-700 transition-colors">Bëj porosinë (Pagesa në dorëzim)</button>
            </form>
        </div>
        <div>
            <h3 class="font-bold text-lg text-black mb-4">Përmbledhja e Porosisë</h3>
            <div id="checkout-summary" class="bg-gray-50 p-4 rounded">
                <!-- Order summary will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
function loadCheckoutSummary() {
    const summary = document.getElementById('checkout-summary');
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    
    summary.innerHTML = `
        <div class="space-y-3">
            ${cartItems.map(item => `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-medium text-black">${item.productName}</p>
                        <p class="text-gray-600 text-sm">Sasia: ${item.quantity}</p>
                    </div>
                    <p class="font-medium text-black">${Math.round(item.productPrice * item.quantity)} ALL</p>
                </div>
            `).join('')}
            
            <hr class="my-3">
            
            <div class="flex justify-between">
                <p class="font-medium text-black">Nëntotali:</p>
                <p class="font-medium text-black">${Math.round(subtotal)} ALL</p>
            </div>
            
            <div class="flex justify-between">
                <p class="font-medium text-black">Dërgesa:</p>
                <p class="font-medium text-black" id="shipping-cost">Zgjidh Shtetin</p>
            </div>
            
            <hr class="my-3">
            
            <div class="flex justify-between text-lg">
                <p class="font-bold text-black">Totali:</p>
                <p class="font-bold text-black" id="total-cost">${Math.round(subtotal)} ALL</p>
            </div>
        </div>
    `;
}

function updateShipping() {
    const country = document.getElementById('checkout-country').value;
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    let shippingCost = 0;
    
    if (country === 'Albania') {
        shippingCost = 300;
    } else if (country === 'Kosovo') {
        shippingCost = 700;
    }
    
    const shippingElement = document.getElementById('shipping-cost');
    const totalElement = document.getElementById('total-cost');
    
    if (shippingElement) {
        shippingElement.textContent = shippingCost > 0 ? `${shippingCost} ALL` : 'Select country';
    }
    
    if (totalElement) {
        totalElement.textContent = `${Math.round(subtotal + shippingCost)} ALL`;
    }
}

async function processOrder(event) {
    event.preventDefault();
    
    const name = document.getElementById('checkout-name').value;
    const email = document.getElementById('checkout-email').value;
    const phone = document.getElementById('checkout-phone').value;
    const country = document.getElementById('checkout-country').value;
    const address = document.getElementById('checkout-address').value;
    const city = document.getElementById('checkout-city').value;
    
    if (!name || !phone || !country || !address || !city) {
        showNotification('Ju lutem plotësoni të gjitha fushat', 'error');
        return;
    }
    
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    let shippingCost = 0;
    
    if (country === 'Albania') {
        shippingCost = 300;
    } else if (country === 'Kosovo') {
        shippingCost = 700;
    }
    
    const orderData = {
        customer_name: name,
        customer_email: email || null,
        customer_phone: phone,
        customer_address: address,
        customer_country: country,
        customer_city: city,
        shipping_cost: shippingCost,
        cart_items: cartItems.map(item => ({
            product_id: item.productId,
            name: item.productName,
            price: item.productPrice,
            quantity: item.quantity,
            image: item.productImage
        }))
    };
    
    try {
        const response = await fetch('/api/order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Clear cart
            cartItems = [];
            localStorage.removeItem('auto_adeal_cart');
            updateCartCount();
            
            // Show success message
            alert(`Porosia u krye me sukses! Numri i porosise: #${result.order_id}\n\nFaleminderit, ${name}! Do t'ju kontaktojme ne ${phone} per te konfirmuar porosine.`);
            
            // Redirect to home
            window.location.href = '/';
        } else {
            showNotification('Porosia dështoi: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Order error:', error);
        showNotification('Porosia dështoi. Provoni përsëri ose na kontaktoni.', 'error');
    }
}

// Load checkout on page load
document.addEventListener('DOMContentLoaded', function() {
    if (cartItems.length === 0) {
        showNotification('Shporta eshte bosh', 'error');
        window.location.href = '/cart';
        return;
    }
    loadCheckoutSummary();
});
</script>
{% endblock %}