<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- Preload critical resources -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">

  <!-- SEO Meta Tags -->
  <title>Auto Adeal - Aksesore dhe Pjese per Makina ne Shqiperi | Cilesi e larte dhe Cmime te uleta</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/favicon/favicon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/favicon/favicon-512.png">

  <meta name="description" content="Blej pjese dhe aksesore per makina online ne Shqiperi dhe Kosove. Cilesi e larte, Cmime te uleta, dergese e shpejte. Produkte per te gjitha markat: VW, BMW, Audi, Mercedes, Toyota dhe me shume.">
  <meta name="keywords" content="pjese, makine, makinash, aksesore, auto, parts, shqiperi, pjese, kembimi, online, butona, sinjale, doreza, leva, leve, marshi, pastrim, detajim, coolant, rezervuar, depozite">
  <meta name="author" content="Auto Adeal">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://autoadeal.com">
  
  <!-- Language -->
  <meta http-equiv="content-language" content="sq-AL">
  <html lang="sq">
  
  <!-- Open Graph (Facebook/Instagram) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Auto Adeal - Pjese per Makina Shqiperi">
  <meta property="og:description" content="Blej pjese dhe aksesore per makina me cilesi te larte dhe cmime te uleta.">
  <meta property="og:image" content="https://autoadeal.com/static/logo.png">
  <meta property="og:url" content="https://autoadeal.com">
  <meta property="og:site_name" content="Auto Adeal">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Auto Adeal - Pjese per Makina Shqiperi">
  <meta name="twitter:description" content="Blej pjese dhe aksesore per makina me cilesi te larte dhe cmime te uleta.">
  <meta name="twitter:image" content="https://autoadeal.com/static/logo.png">
  
  <style>

#scroll-to-top-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: #dc2626;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    z-index: 999999 !important;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transform: scale(0.8);
    transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
    pointer-events: none;
}

#scroll-to-top-btn.visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
    pointer-events: auto;
}

#scroll-to-top-btn:hover {
    background: #b91c1c;
    transform: scale(1.1);
}

#scroll-to-top-btn:active {
    transform: scale(0.95);
}

@media (max-width: 767px) {
    #scroll-to-top-btn {
        width: 60px;
        height: 60px;
        bottom: 20px;
        right: 15px;
    }
}

/* Critical CSS - Load first to prevent glitching */
header {
    position: relative;
    z-index: 100;
}

header .container {
    position: relative;
}

header img,
header svg,
header button,
header input {
    display: block;
}

/* Prevent layout shift */
#site-logo,
#site-logo-mobile {
    height: 3rem;
    width: auto;
}

#search-input,
#search-input-mobile {
    min-height: 40px;
}

/* Lock badge positions */
#wishlist-count,
#cart-count,
#wishlist-count-mobile,
#cart-count-mobile {
    position: absolute;
    top: -0.5rem;
    right: -0.5rem;
    min-width: 1.25rem;
    min-height: 1.25rem;
}
</style>
  <title>Auto Adeal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        /* Prevent flash of unstyled content */
        .page-content {
            opacity: 0;
            transition: opacity 0.2s ease-in;
        }
        
        .page-content.loaded {
            opacity: 1;
        }
        
        /* Prevent header elements from jumping */
        header {
            min-height: 64px;
        }

        header .container {
            min-height: inherit;
        }

        nav {
            min-height: 56px;
        }

        /* Prevent layout shifts during load */
        header, header *, nav, nav * {
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        /* Ensure consistent sizing */
        #search-input, #search-input-mobile,
        #account-button, #account-button-mobile {
            opacity: 1;
            will-change: auto;
        }

        /* Fix badge positions */
        #wishlist-count, #cart-count,
        #wishlist-count-mobile, #cart-count-mobile {
            position: absolute;
            top: -8px;
            right: -8px;
            transform: translateZ(0);
        }

        body {
            box-sizing: border-box;
        }

        .category-item:hover {
            background-color: #f3f4f6;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .product-card {
            transition: all 0.3s ease;
        }
        .price-slider {
            position: relative;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin: 20px 0;
        }
        .price-slider-track {
            position: absolute;
            height: 6px;
            background: #8c1d1d;
            border-radius: 3px;
        }
        .price-slider-thumb {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #8c1d1d;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            top: -7px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .price-slider-thumb:hover {
            background: #6b1515;
        }
        .price-values {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #6b7280;

        }
        #account-dropdown {
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        * {
            box-sizing: border-box;
        }
        html, body {
            overflow-x: hidden;
            max-width: 100%;
        }
        
        #products-section {
            width: 100%;
        }
        
        @media (max-width: 768px) {
            #products-container {
                width: 100vw;
                margin-left: calc(-1 * (100vw - 100%) / 2);
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            .product-card {
                width: 100%;
                max-width: none;
            }
        }

        #products-container {
            transition: opacity 0.15s ease-in-out;
        }
   
        /* Banner Container */
        #home-banner {
            margin: 0;
            padding: 0;
            width: 100%;
        }

        /* Mobile: Full viewport width, ignore padding */
        @media (max-width: 767px) {
            #home-banner {
                width: 100vw;
                position: relative;
                left: 50%;
                right: 50%;
                margin-left: -50vw;
                margin-right: -50vw;
                margin-top: -1rem;
                margin-bottom: 0;
            }
        }

        /* Desktop: Full width within main content, negative margin to touch edges */
        @media (min-width: 768px) {
            #home-banner {
                width: calc(100% + 3rem);
                margin-left: -1.5rem;
                margin-right: -1.5rem;
                margin-top: -1.5rem;
                margin-bottom: 1rem;
            }
        }

        #banner-image {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }

        /* Mobile banner heights */
        @media (max-width: 767px) {
            #banner-image {
                min-height: 120px;
                max-height: 200px;
            }
        }

        /* Tablet banner heights */
        @media (min-width: 768px) and (max-width: 1023px) {
            #banner-image {
                min-height: 180px;
                max-height: 250px;
            }
        }

        /* Desktop banner heights */
        @media (min-width: 1024px) and (max-width: 1279px) {
            #banner-image {
                min-height: 220px;
                max-height: 300px;
            }
        }

        /* Large desktop banner heights */
        @media (min-width: 1280px) {
            #banner-image {
                min-height: 250px;
                max-height: 350px;
            }
        }

        /* Position auth modal lower on mobile to avoid header overlap */
        @media (max-width: 767px) {
            #auth-modal {
                align-items: flex-start;
                padding-top: 140px;
            }
    
            #auth-modal > div {
                margin-top: 0 !important;
            }
        }

        /* Prevent zoom on input focus for mobile */
        @media (max-width: 767px) {
            input[type="text"],
            input[type="email"],
            input[type="password"],
            input[type="tel"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important;
            }
        }

    </style>

    <!-- Organization Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "AutoPartsStore",
    "name": "Auto Adeal",
    "image": "https://autoadeal.com/static/logo.png",
    "url": "https://autoadeal.com",
    "telephone": "+355685526714",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Sarande",
      "addressCountry": "AL"
    },
    "priceRange": "$$",
    "openingHoursSpecification": {
      "@type": "OpeningHoursSpecification",
      "dayOfWeek": [
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday",
        "Sunday"
      ],
      "opens": "00:00",
      "closes": "23:59"
    }
  }
  </script>
  
  <style>@view-transition { navigation: auto; }</style>
    
 </head>
 <body class="h-full bg-white overflow-x-hidden"><!-- Header -->
  <header class="bg-black text-white py-3 md:py-4" style="min-height: 64px; position: relative; z-index: 100;">
   <div class="container mx-auto px-4 md:px-6">
    <!-- Mobile Layout -->
    <div class="md:hidden">
      <!-- Top Row: Menu, Logo and Icons -->
      <div class="flex items-center justify-between mb-3" style="position: relative; z-index: 200;">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" onclick="toggleMobileMenu()" class="text-white mr-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
        
        <button onclick="showPage('home'); loadPopularProducts();" class="flex items-center flex-1 h-8 hover:opacity-80 transition-opacity">
            <img id="site-logo-mobile" src="/static/logo.png" alt="Logo" class="h-full w-auto object-contain" style="display: none;">
            <span id="logo-text-mobile" class="text-xl font-bold text-white ml-1"></span>
        </button>

        
        <div class="flex items-center space-x-4">
          <!-- Account Dropdown -->
          <div class="relative">
            <button id="account-button-mobile" onclick="toggleAccountDropdown()" class="flex items-center text-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
               <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
            </button>
            
            <!-- Mobile Account Dropdown Menu -->
            <div id="account-dropdown-mobile" class="hidden absolute right-0 w-48 bg-white rounded-lg shadow-xl py-2" style="top: calc(100% + 8px); z-index: 300;">
              <!-- Logged Out Options -->
              <div id="logged-out-options-mobile">
                <button onclick="showLoginModal(); closeAccountDropdown();" class="w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">
                  Hyr
                </button>
                <button onclick="showSignupModal(); closeAccountDropdown();" class="w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">
                  Regjistrohu
                </button>
              </div>
              
              <!-- Logged In Options -->
              <div id="logged-in-options-mobile" class="hidden">
               <div class="px-4 py-2 border-b border-gray-200">
                <p id="dropdown-user-name-mobile" class="font-semibold text-black text-sm"></p>
                <p id="dropdown-user-email-mobile" class="text-xs text-gray-600 truncate"></p>
               </div>
                <button onclick="logout(); closeAccountDropdown();" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 transition-colors">
                   Dil
                </button>
              </div>
            </div>
          </div>
          
          <!-- Wishlist -->
          <button onclick="showWishlist()" class="relative">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            <span id="wishlist-count-mobile" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">0</span>
          </button>
          
          <!-- Cart -->
          <button onclick="showPage('cart')" class="relative">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.2 6h12.8M10 19a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z"/>
            </svg>
            <span id="cart-count-mobile" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">0</span>
          </button>
        </div>
      </div>
      
      <!-- Bottom Row: Search -->
      <div class="flex" style="position: relative; z-index: 50;">
        <input type="text" id="search-input-mobile" placeholder="Kërko..." class="flex-1 px-4 py-2 rounded-l-full text-black focus:outline-none text-sm">
        <button onclick="performSearchMobile()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-r-full transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35m1.6-5.65a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Desktop Layout (Keep Original) -->
    <div class="hidden md:flex items-center justify-between"><!-- Logo -->
    <div class="flex items-center ml-8">
       <button onclick="showPage('home'); loadPopularProducts();" class="flex items-center hover:opacity-80 transition-opacity select-none">
         <img id="site-logo" src="/static/logo.png" alt="Logo" class="h-12 md:h-14 w-auto max-w-[250px] object-contain pointer-events-none" style="display: none;" draggable="false">
         <span id="logo-text" class="text-2xl font-bold text-white"></span>
       </button>
     </div>
    <!-- Search Bar -->
     <div class="flex-1 max-w-md mx-8">
      <div class="flex"><input type="text" id="search-input" placeholder="Kërko..." class="flex-1 px-4 py-2 rounded-l-full text-black focus:outline-none"> <button
  onclick="performSearch()"
  class="relative bg-red-600 hover:bg-red-700 pl-6 pr-7 py-2 rounded-r-full transition-colors flex items-center"
>
  <svg xmlns="http://www.w3.org/2000/svg"
       class="w-5 h-5 text-white"
       fill="none"
       viewBox="0 0 24 24"
       stroke="currentColor"
       stroke-width="3"
       style="transform: translateX(-3px);">
    <path stroke-linecap="round" stroke-linejoin="round"
          d="M21 21l-4.35-4.35m1.6-5.65a7 7 0 11-14 0 7 7 0 0114 0z" />
  </svg>
      </button>
      </div>
     </div><!-- Right Side Controls -->
     <div class="flex items-center space-x-6">
      <!-- Account Dropdown -->
      <div class="relative">
        <!-- Account Button (always visible) -->
        <button id="account-button" onclick="toggleAccountDropdown()" class="flex items-center space-x-2 text-white hover:text-red-500 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
          <span id="account-label">Llogaria</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        
        <!-- Dropdown Menu -->
        <div id="account-dropdown" class="hidden absolute right-0 mt-2 w-34 bg-white rounded-lg shadow-lg py-2 z-[110]">
          <!-- Logged Out Options -->
          <div id="logged-out-options">
            <button onclick="showLoginModal(); closeAccountDropdown();" class="w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">
              Hyr
            </button>
            <button onclick="showSignupModal(); closeAccountDropdown();" class="w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">
              Regjistrohu
            </button>
          </div>
          
          <!-- Logged In Options -->
          <div id="logged-in-options" class="hidden">
            <div class="px-4 py-2 border-b border-gray-200">
              <p id="dropdown-user-name" class="font-semibold text-black text-sm"></p>
              <p id="dropdown-user-email" class="text-xs text-gray-600 truncate"></p>
            </div>
            <button onclick="logout(); closeAccountDropdown();" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 transition-colors">
              Dil
            </button>
          </div>
        </div>
      </div>
  <!-- Wishlist -->
  <button onclick="showWishlist()" class="relative hover:text-red-500 transition-colors flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg"
         class="w-6 h-6 text-white"
         fill="none"
         viewBox="0 0 24 24"
         stroke="currentColor"
         stroke-width="2.5">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
    </svg>
    <span id="wishlist-count"
          class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">0</span>
  </button>

  <!-- Cart -->
  <button onclick="showPage('cart')" class="relative hover:text-red-500 transition-colors flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg"
         class="w-6 h-6 text-white"
         fill="none"
         viewBox="0 0 24 24"
         stroke="currentColor"
         stroke-width="2.5">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.2 6h12.8M10 19a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z"/>
    </svg>
    <span id="cart-count"
          class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">0</span>
  </button>
      </div>
     </div>
    </div> <!-- End desktop layout -->
   </div>
  </header>
  <!-- Mobile Category Menu Overlay -->
  <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[150] hidden" onclick="closeMobileMenu()"></div>
  <div id="mobile-menu" class="fixed top-0 left-0 h-full w-80 bg-white z-[200] transform -translate-x-full transition-transform duration-300 overflow-y-auto">
    <div class="p-4 bg-black text-white flex items-center justify-between">
      <h3 class="font-bold text-lg">Kategoritë</h3>
      <button onclick="closeMobileMenu()" class="text-white">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div id="mobile-categories-container" class="p-4">
      <!-- Categories will be loaded here -->
    </div>
  </div>
  <!-- Navigation Bar -->
  <nav class="bg-white border-b border-gray-200 py-4" style="min-height: 56px; position: relative; z-index: 90;">
   <div class="container mx-auto px-4 md:px-6">
    <div class="flex justify-center space-x-6 md:space-x-24 overflow-x-auto"><button onclick="showPage('home'); loadPopularProducts();"class="text-black hover:text-red-600 font-medium transition-colors text-sm whitespace-nowrap">Kryefaqja</button>
       <button onclick="showPage('special-offers')" class="text-black hover:text-red-600 font-medium transition-colors text-sm whitespace-nowrap">Oferta Speciale</button>
       <button onclick="showPage('brands')" class="text-black hover:text-red-600 font-medium transition-colors text-sm whitespace-nowrap">Marka</button>
       <button onclick="showPage('contact')" class="text-black hover:text-red-600 font-medium transition-colors text-sm whitespace-nowrap">Na Kontaktoni</button>
    </div>
   </div>
  </nav><!-- Main Content -->
  <div class="md:flex min-h-screen"><!-- Sidebar -->
   <aside id="sidebar" class="hidden md:block md:w-64 bg-gray-50 p-4 md:p-6">   
    <div id="categories-section">
        <h3 class="font-bold text-lg mb-4 text-black">Kategoritë</h3>
        <!-- ✅ This container will be filled dynamically -->
        <div id="categories-container" class="space-y-3"></div>
    </div>

    <div id="filters-section" style="display: none;">
     <div class="flex items-center justify-between mb-4">
      <h3 class="font-bold text-lg text-black">Filtrat</h3><button onclick="showCategories()" class="text-red-600 hover:text-red-700 text-sm">← Kategoritë</button>
     </div>
     <div id="dynamic-filters" class="space-y-4"><!-- Dynamic filters will be populated here -->
     </div><button onclick="applyFilters()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors mt-4"> Apliko Filtrat </button>
    </div>
   </aside>
   <!-- Mobile Filters Button & Panel -->
  <div id="mobile-filters-container" class="md:hidden bg-white border-b border-gray-200" style="display: none;">
    <button id="mobile-filters-toggle" onclick="toggleMobileFilters()" class="w-full px-4 py-3 flex items-center justify-between text-left" style="display: none;">
      <span class="font-semibold text-black flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
        </svg>
        Filtrat
      </span>
      <svg id="mobile-filters-arrow" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-600 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
      </svg>
    </button>
    
    <div id="mobile-filters-panel" class="hidden px-4 pb-4">
      <div id="mobile-dynamic-filters" class="space-y-4">
        <!-- Filters will be loaded here -->
      </div>
      <button onclick="applyMobileFilters()" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors mt-4 font-medium">
        Apliko Filtrat
      </button>
    </div>
  </div>
   <!-- Main Content Area -->
   <main class="flex-1 p-4 md:p-6" id="main-content"><!-- Home Page -->
    <div id="home-page" class="page-content p-0 md:p-0">
     <!-- Banner Section -->
     <div id="home-banner" class="hidden">
      <div class="cursor-pointer overflow-hidden hover:opacity-95 transition-opacity" onclick="handleBannerClick()">
        <img id="banner-image" src="" alt="Banner">
      </div>
    </div>
    <!-- ✅ Products Section -->
    <div id="products-section" class="w-full">
    <h3 id="products-title" class="text-xl md:text-2xl font-bold mb-4 text-black px-3 md:px-6 pt-4 md:pt-6">Të Fundit</h3>
    <div id="products-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-6 px-2 md:px-6 pb-4 md:pb-6">
    <!-- Products will appear here -->
    </div>
    </div>
    </div><!-- Special Offers Page -->
    <div id="special-offers-page" class="page-content" style="display: none;">
     <h1 class="text-3xl font-bold text-black mb-6">Oferta Speciale</h1>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="offers-grid"><!-- Special offers will be loaded here -->
     </div>
    </div><!-- Brands Page -->
    <div id="brands-page" class="page-content" style="display: none;">
     <h1 class="text-3xl font-bold text-black mb-6">Markat e Makinave</h1>
     <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-6" id="brands-grid">
      <!-- Brands will be loaded here -->
     </div>
    </div>
    
    <!-- Brand Products Page -->
    <div id="brand-products-page" class="page-content" style="display: none;">
     <div class="flex items-center justify-between mb-6">
      <h1 id="brand-title" class="text-3xl font-bold text-black"></h1><button onclick="event.preventDefault(); event.stopPropagation(); window.history.back();" class="text-red-600 hover:text-red-700 cursor-pointer">← Kthehu</button>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="brand-products-grid"><!-- Brand products will be loaded here -->
     </div>
    </div>
    
    <div id="contact-page" class="page-content" style="display: none;"> 
        <h1 class="text-3xl font-bold text-black mb-8 text-center">Na Kontaktoni</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-12 max-w-5xl mx-auto">
            <!-- Contact Information -->
            <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg text-black mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              Ku Mund te na Kontaktoni
            </h3>
            <div class="space-y-3 text-gray-700">
              <p><strong>Email:</strong> <span id="contact-email-display">autoadeal@gmail.com</span></p>
              <p><strong>Whatsapp:</strong> <span id="contact-phone-display">+355 68 552 6714</span></p>
              <p><strong>Vendndodhja:</strong> <span id="contact-location-display">Sarande, Shqiperi</span></p>
              <p><strong>Instagram:</strong> 
                <a href="https://www.instagram.com/autoadeal" target="_blank" class="text-red-600 hover:text-red-700">@autoadeal</a>
              </p>
            </div>
            </div>
            <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg text-black mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
              </svg>
              Politika e Dergesave
            </h3>
            <ul class="space-y-3 text-gray-700">
              <li><strong>Shqiperi:</strong> Kushton 300 ALL dhe vonon 2–4 dite</li>
              <li><strong>Kosove:</strong> Kushton 700 ALL dhe vonon 4–5 dite</li>
            </ul>
            <p class="text-gray-600 mt-4 text-sm">
              Porosite procesohen cdo dite. Koha e dergeses varjon nga vendndodhja juaj specifike. Na kontaktoni ne Instagram ose Whatsapp per cdo problem ne lidhje me porosine tuaj.
            </p>
            </div>
        </div> 

        <!-- Extra Section to Fill Page -->
        <div class="mt-16 text-center max-w-4xl mx-auto">
          <h3 class="text-2xl font-bold text-black mb-4 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            Keni Nevoje per Ndihme per te Vendosur?
          </h3>
          <p class="text-gray-700 text-lg mb-6">
            Ekipi yne eshte gjithmone gati t'ju ndihmoje te zgjidhni aksesoret ose pjeset e duhura per automjetin tuaj. 
            Na kontaktoni ne <span class="text-red-600 font-semibold">Instagram</span> ose Whatsapp per ndihme te shpejte.
          </p>
          
          <div class="flex justify-center space-x-4 mt-6">
            <a href="https://www.instagram.com/autoadeal" target="_blank"
              class="bg-red-600 text-white px-8 py-3 rounded-full hover:bg-red-700 transition-colors font-medium flex items-center space-x-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
              </svg>
              <span>Instagram</span>
            </a>
            
            <a href="https://wa.me/355685526714" target="_blank" 
              class="bg-green-500 text-white px-8 py-3 rounded-full hover:bg-green-600 transition-colors font-medium flex items-center space-x-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
              </svg>
              <span>Whatsapp</span>
            </a>
          </div>
        </div>
    </div>
                    

    <!-- Product Detail Page -->
    <div id="product-detail-page" class="page-content" style="display: none;"><button id="product-back-btn" class="text-red-600 hover:text-red-700 mb-4 cursor-pointer font-medium text-lg">← Kthehu</button>
     <div id="product-detail-content"><!-- Product details will be loaded here -->
     </div>
    </div>
    
    <!-- Checkout Page -->
    <div id="checkout-page" class="page-content" style="display: none;">
     <h1 class="text-3xl font-bold text-black mb-6">Pagesa</h1>
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div>
       <h3 class="font-bold text-lg text-black mb-4">Informacioni i Dërgesës</h3>
       <form id="checkout-form" onsubmit="processOrder(event)" class="space-y-4"><input type="text" id="checkout-name" placeholder="Emri i Plote" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <input type="tel" id="checkout-phone" placeholder="Numri i telefonit" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <select id="checkout-country" onchange="updateShipping()" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <option value="">Zgjidh Shtetin</option> <option value="Albania">Shqiperi</option> <option value="Kosovo">Kosovë</option> </select> <input type="text" id="checkout-city" placeholder="Qyteti" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <button type="submit" class="w-full bg-red-600 text-white py-3 rounded hover:bg-red-700 transition-colors">Bëj porosinë (Pagesa në dorëzim)</button>
       </form>
      </div>
      <div>
       <h3 class="font-bold text-lg text-black mb-4">Përmbledhja e Porosisë</h3>
       <div id="checkout-summary" class="bg-gray-50 p-4 rounded"><!-- Order summary will be loaded here -->
       </div>
      </div>
     </div>
    </div>
    
    <!-- Cart Page -->
    <div id="cart-page" class="page-content" style="display: none;">
     <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-black">Shporta</h1><button onclick="showPage('home')" class="text-red-600 hover:text-red-700">← Kthehu</button>
     </div>
     <div id="cart-content"><!-- Cart content will be loaded here -->
     </div>
    </div>
    
    <!-- Wishlist Page -->
    <div id="wishlist-page" class="page-content" style="display: none;">
     <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-black">Lista e dëshirave</h1><button onclick="showPage('home')" class="text-red-600 hover:text-red-700">← Kthehu</button>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="wishlist-grid"><!-- Wishlist items will be loaded here -->
     </div>
    </div>
   </main>
  </div>
  
  <!-- Login/Signup Modal -->
  <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[300]" style="display: none;">
   <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
    <div class="flex justify-between items-center mb-6">
     <h2 id="auth-title" class="text-2xl font-bold text-black">Hyr</h2><button onclick="closeAuthModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
    </div><!-- Login Form -->
    <form id="login-form" onsubmit="handleLogin(event)">
     <div class="space-y-4"><input type="email" id="login-email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <button type="submit" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors">Hyr</button>
     </div>
     <div class="mt-4 text-center"><button type="button" onclick="showForgotPassword()" class="text-red-600 hover:text-red-700 text-sm">Ke harruar fjalëkalimin?</button>
     </div>
     <div class="mt-4 text-center"><button type="button" onclick="showSignupForm()" class="text-gray-600 hover:text-gray-800">Nuk ke llogari? Regjistrohu</button>
     </div>
    </form><!-- Signup Form -->
    <form id="signup-form" onsubmit="handleSignup(event)" style="display: none;">
     <div class="space-y-4"><input type="text" id="signup-name" placeholder="Emri" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <input type="text" id="signup-surname" placeholder="Mbiemri" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <input type="email" id="signup-email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <input type="password" id="signup-password" placeholder="Password" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <button type="submit" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors">Regjistrohu</button>
     </div>
     <div class="mt-4 text-center"><button type="button" onclick="showLoginForm()" class="text-gray-600 hover:text-gray-800">Ke një llogari? Hyr</button>
     </div>
    </form><!-- Forgot Password Form -->
    <form id="forgot-form" onsubmit="handleForgotPassword(event)" style="display: none;">
     <div class="space-y-4">
      <p class="text-gray-600 text-sm">Shkruaj emailin tënd për të marrë udhëzimet e rikuperimit të fjalëkalimit.</p><input type="email" id="forgot-email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <button type="submit" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors">Dërgo emailin e rikuperimit</button>
     </div>
     <div class="mt-4 text-center"><button type="button" onclick="showLoginForm()" class="text-gray-600 hover:text-gray-800">← Kthehu te hyrja</button>
     </div>
    </form>
   </div>
  </div>

  <!-- Scroll to Top Button -->
  <button id="scroll-to-top-btn" type="button" aria-label="Scroll to top">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"/>
    </svg>
  </button>

  <script>
// ============================================
// GLOBAL STATE & CONFIGURATION
// ============================================

let currentPage = 'home';
let previousPage = 'home';
let cartItems = [];
let wishlistItems = [];
let categoriesData = [];
window.isNavigatingHistory = false;

const EUR_TO_ALL = 94.34; // Keep this

// ============================================
// AUTHENTICATION
// ============================================
function loadUserFromStorage() {
    const stored = localStorage.getItem('auto_adeal_user');
    const loginTime = localStorage.getItem('auto_adeal_login_time');
    
    if (stored && loginTime) {
        const daysSinceLogin = (Date.now() - parseInt(loginTime)) / (1000 * 60 * 60 * 24);
        
        if (daysSinceLogin < 730) { // 730 days = 2 years
            try {
                currentUser = JSON.parse(stored);
                updateAuthUI();
            } catch (e) {
                localStorage.removeItem('auto_adeal_user');
                localStorage.removeItem('auto_adeal_login_time');
            }
        } else {
            // Login expired
            localStorage.removeItem('auto_adeal_user');
            localStorage.removeItem('auto_adeal_login_time');
        }
    }
}

function saveUserToStorage(user) {
    localStorage.setItem('auto_adeal_user', JSON.stringify(user));
    localStorage.setItem('auto_adeal_login_time', Date.now().toString());
}

function updateAuthUI() {
    const accountLabel = document.getElementById('account-label');
    const loggedOutOptions = document.getElementById('logged-out-options');
    const loggedInOptions = document.getElementById('logged-in-options');
    const dropdownUserName = document.getElementById('dropdown-user-name');
    const dropdownUserEmail = document.getElementById('dropdown-user-email');
    
    // Mobile elements
    const loggedOutOptionsMobile = document.getElementById('logged-out-options-mobile');
    const loggedInOptionsMobile = document.getElementById('logged-in-options-mobile');
    const dropdownUserNameMobile = document.getElementById('dropdown-user-name-mobile');
    const dropdownUserEmailMobile = document.getElementById('dropdown-user-email-mobile');
    
    if (currentUser) {
        if (accountLabel) accountLabel.textContent = currentUser.name;
        if (loggedOutOptions) loggedOutOptions.classList.add('hidden');
        if (loggedInOptions) loggedInOptions.classList.remove('hidden');
        if (dropdownUserName) dropdownUserName.textContent = `${currentUser.name} ${currentUser.surname}`;
        if (dropdownUserEmail) dropdownUserEmail.textContent = currentUser.email;
        
        // Mobile
        if (loggedOutOptionsMobile) loggedOutOptionsMobile.classList.add('hidden');
        if (loggedInOptionsMobile) loggedInOptionsMobile.classList.remove('hidden');
        if (dropdownUserNameMobile) dropdownUserNameMobile.textContent = `${currentUser.name} ${currentUser.surname}`;
        if (dropdownUserEmailMobile) dropdownUserEmailMobile.textContent = currentUser.email;
    } else {
        if (accountLabel) accountLabel.textContent = 'Account';
        if (loggedOutOptions) loggedOutOptions.classList.remove('hidden');
        if (loggedInOptions) loggedInOptions.classList.add('hidden');
        
        // Mobile
        if (loggedOutOptionsMobile) loggedOutOptionsMobile.classList.remove('hidden');
        if (loggedInOptionsMobile) loggedInOptionsMobile.classList.add('hidden');
    }
}

function showLoginModal() {
    document.getElementById('auth-modal').style.display = 'flex';
    document.getElementById('auth-title').textContent = 'Hyr';
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('signup-form').style.display = 'none';
    document.getElementById('forgot-form').style.display = 'none';
}

function showSignupModal() {
    document.getElementById('auth-modal').style.display = 'flex';
    document.getElementById('auth-title').textContent = 'Regjistrohu';
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('signup-form').style.display = 'block';
    document.getElementById('forgot-form').style.display = 'none';
}

function closeAuthModal() {
    document.getElementById('auth-modal').style.display = 'none';
    // Reset forms
    document.getElementById('login-form').reset();
    document.getElementById('signup-form').reset();
    document.getElementById('forgot-form').reset();
}

function showLoginForm() {
    showLoginModal();
}

function showSignupForm() {
    showSignupModal();
}

function showForgotPassword() {
    document.getElementById('auth-title').textContent = 'Rivendos fjalëkalimin';
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('signup-form').style.display = 'none';
    document.getElementById('forgot-form').style.display = 'block';
}

async function handleLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentUser = data.user;
            saveUserToStorage(data.user);
            updateAuthUI();
            closeAuthModal();
            showNotification('Hyra u krye me sukses!', 'success');
        } else {
            if (data.error === 'Invalid email or password') {
                showNotification('Email ose fjalëkalim i gabuar', 'error');
            } else {
                showNotification(data.error || 'Hyra dështoi', 'error');
            }
        }
    } catch (error) {
        console.error('Login error:', error);
        showNotification('Hyra dështoi. Provoni përsëri.', 'error');
    }
}

async function handleSignup(event) {
    event.preventDefault();
    
    const name = document.getElementById('signup-name').value;
    const surname = document.getElementById('signup-surname').value;
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    
    try {
        const response = await fetch('/api/auth/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, surname, email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentUser = data.user;
            saveUserToStorage(data.user);
            updateAuthUI();
            closeAuthModal();
            showNotification('Llogaria u krijua me sukses!', 'success');
        } else {
            if (data.error === 'Email already registered') {
                showNotification('Ky email është tashmë në përdorim', 'error');
            } else {
                showNotification(data.error || 'Regjistrimi dështoi', 'error');
            }
        }
    } catch (error) {
        console.error('Signup error:', error);
        showNotification('Regjistrimi dështoi. Provoni përsëri.', 'error');
    }
}

async function handleForgotPassword(event) {
    event.preventDefault();
    
    const email = document.getElementById('forgot-email').value;
    
    try {
        const response = await fetch('/api/auth/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('Link për rikthimin e fjalëkalimit u dërgua në email', 'success');
            closeAuthModal();
        } else {
            showNotification(data.error || 'Kerkesa deshtoi', 'error');
        }
    } catch (error) {
        console.error('Forgot password error:', error);
        showNotification('Kerkesa deshtoi', 'error');
    }
}

function logout() {
    currentUser = null;
    localStorage.removeItem('auto_adeal_user');
    localStorage.removeItem('auto_adeal_login_time');
    updateAuthUI();
    showNotification('Dalja u krye me sukses', 'success');
}

function toggleAccountDropdown() {
    const dropdown = document.getElementById('account-dropdown');
    const dropdownMobile = document.getElementById('account-dropdown-mobile');
    
    if (dropdown) dropdown.classList.toggle('hidden');
    if (dropdownMobile) dropdownMobile.classList.toggle('hidden');
}

function closeAccountDropdown() {
    const dropdown = document.getElementById('account-dropdown');
    const dropdownMobile = document.getElementById('account-dropdown-mobile');
    
    if (dropdown) dropdown.classList.add('hidden');
    if (dropdownMobile) dropdownMobile.classList.add('hidden');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const accountButton = document.getElementById('account-button');
    const accountButtonMobile = document.getElementById('account-button-mobile');
    const dropdown = document.getElementById('account-dropdown');
    const dropdownMobile = document.getElementById('account-dropdown-mobile');
    
    const clickedAccountButton = accountButton && accountButton.contains(event.target);
    const clickedAccountButtonMobile = accountButtonMobile && accountButtonMobile.contains(event.target);
    const clickedDropdown = dropdown && dropdown.contains(event.target);
    const clickedDropdownMobile = dropdownMobile && dropdownMobile.contains(event.target);
    
    if (!clickedAccountButton && !clickedAccountButtonMobile && !clickedDropdown && !clickedDropdownMobile) {
        if (dropdown) dropdown.classList.add('hidden');
        if (dropdownMobile) dropdownMobile.classList.add('hidden');
    }
});

// ============================================
// INITIALIZATION
// ============================================
async function initializeApp() {
    console.log('🚀 Initializing app...');
    // Load site settings
    await loadSiteSettings();
    // Load cart and wishlist FIRST before anything else
    loadCartFromStorage();
    loadWishlistFromStorage();
    updateCartCount();
    updateWishlistCount();
    
    // Load user session
    loadUserFromStorage();
    
    // Load categories
    await loadCategories();
    
    // Set initial history state if none exists
    if (!window.history.state) {
        window.history.replaceState({ 
            page: 'home',
            timestamp: Date.now()
        }, '', '/');
    }
    
    // Check URL and load appropriate page
    const hash = window.location.hash.substring(1);
    if (hash.startsWith('product/')) {
        const productId = hash.split('/')[1];
        await showProductDetail(parseInt(productId));
    } else if (hash.startsWith('brand/')) {
        const brandName = decodeURIComponent(hash.split('/')[1]);
        await showBrandProducts(brandName);
    } else if (hash) {
        showPage(hash, false);
    } else {
        // Load popular products on home page
        await loadPopularProducts();
    }
    
    // Show page content after everything is loaded
    setTimeout(() => {
        document.querySelectorAll('.page-content').forEach(page => {
            page.classList.add('loaded');
        });
    }, 100);

    // Mark body as loaded
    document.body.classList.add('loaded');
    
    console.log('✅ App initialized');
}

let bannerLinkTarget = '';

async function loadSiteSettings() {
    try {
        const response = await fetch('/api/settings');
        const settings = await response.json();
        
        // Update logo
        if (settings.logo_url) {
            const logoDesktop = document.getElementById('site-logo');
            const logoMobile = document.getElementById('site-logo-mobile');
            const logoTextDesktop = document.getElementById('logo-text');
            const logoTextMobile = document.getElementById('logo-text-mobile');
            
            if (logoDesktop && logoMobile) {
                logoDesktop.src = settings.logo_url;
                logoMobile.src = settings.logo_url;
                logoDesktop.style.display = 'block';
                logoMobile.style.display = 'block';
                
                // Hide text if logo is set
                if (logoTextDesktop) logoTextDesktop.style.display = 'none';
                if (logoTextMobile) logoTextMobile.style.display = 'none';
            }
        }
        
        // Update site name
        if (settings.site_name) {
            const logoTextDesktop = document.getElementById('logo-text');
            const logoTextMobile = document.getElementById('logo-text-mobile');
            if (logoTextDesktop) logoTextDesktop.textContent = settings.site_name;
            if (logoTextMobile) logoTextMobile.textContent = settings.site_name;
        }
        
        // Update banner
        console.log('Banner settings:', settings.banner_enabled, settings.banner_image);
        if (settings.banner_enabled === 'true' && settings.banner_image) {
            const banner = document.getElementById('home-banner');
            const bannerImg = document.getElementById('banner-image');
            
            if (banner && bannerImg) {
                bannerImg.src = settings.banner_image;
                bannerImg.onload = () => {
                    banner.classList.remove('hidden');
                    console.log('✓ Banner loaded successfully');
                };
                bannerImg.onerror = () => {
                    console.error('❌ Failed to load banner image');
                };
                bannerLinkTarget = settings.banner_link || '';
            }
        } else {
            const banner = document.getElementById('home-banner');
            if (banner) banner.classList.add('hidden');
        }
    } catch (error) {
        console.error('Failed to load site settings:', error);
    }
}

function handleBannerClick() {
    if (bannerLinkTarget) {
        // Check if it's a subcategory ID (number)
        if (!isNaN(bannerLinkTarget)) {
            loadSubcategoryProducts(parseInt(bannerLinkTarget), 'Featured Products');
        } else {
            // Otherwise treat as a page
            showPage(bannerLinkTarget);
        }
    }
}

// ============================================
// CATEGORIES & NAVIGATION
// ============================================
async function loadCategories() {
    try {
        const response = await fetch('/api/categories');
        categoriesData = await response.json();
        renderCategories();
    } catch (error) {
        console.error('❌ Failed to load categories:', error);
        showNotification('Ngarkimi i kategorive deshtoi', 'error');
    }
}

function renderCategories() {
    const container = document.getElementById('categories-container');
    container.innerHTML = '';

    for (const category of categoriesData) {
        const catDiv = document.createElement('div');
        catDiv.classList.add('mb-4');

        // Category title
        const catTitle = document.createElement('h4');
        catTitle.classList.add('font-semibold', 'text-black', 'mb-2', 'cursor-pointer', 
                               'hover:text-red-600', 'transition-colors');
        catTitle.textContent = category.name;
        catTitle.onclick = () => toggleSubcategories(category.id);
        catDiv.appendChild(catTitle);

        // Subcategory list
        const subList = document.createElement('div');
        subList.classList.add('space-y-1', 'ml-3', 'hidden');
        subList.id = `subcats-${category.id}`;
        
        // Add subcategories first
        for (const sub of category.subcategories) {
            const btn = document.createElement('button');
            btn.textContent = sub.name;
            btn.classList.add('w-full', 'text-left', 'px-3', 'py-2', 'rounded', 
                             'text-black', 'hover:bg-gray-200', 'transition-colors', 'text-sm');
            btn.onclick = () => loadSubcategoryProducts(sub.id, sub.name);
            subList.appendChild(btn);
        }
        
        // Add "Te gjitha" button at the bottom
        const allBtn = document.createElement('button');
        allBtn.textContent = 'Te gjitha';
        allBtn.classList.add('w-full', 'text-left', 'px-3', 'py-2', 'rounded', 
                             'text-black', 'hover:bg-gray-200', 'transition-colors', 'text-sm');
        allBtn.onclick = () => loadCategoryProducts(category.id, category.name);
        subList.appendChild(allBtn);

        catDiv.appendChild(subList);
        container.appendChild(catDiv);
    }
}

function renderMobileCategories() {
    const container = document.getElementById('mobile-categories-container');
    if (!container) return;
    
    container.innerHTML = '';

    for (const category of categoriesData) {
        const catDiv = document.createElement('div');
        catDiv.classList.add('mb-4', 'border-b', 'border-gray-200', 'pb-4');

        // Category title
        const catTitle = document.createElement('h4');
        catTitle.classList.add('font-semibold', 'text-black', 'mb-2', 'cursor-pointer', 
                               'hover:text-red-600', 'transition-colors', 'text-base');
        catTitle.textContent = category.name;
        catTitle.onclick = () => toggleMobileSubcategories(category.id);
        catDiv.appendChild(catTitle);

        // Subcategory list
        const subList = document.createElement('div');
        subList.classList.add('space-y-1', 'ml-3', 'hidden');
        subList.id = `mobile-subcats-${category.id}`;
        
        // Add subcategories first
        for (const sub of category.subcategories) {
            const btn = document.createElement('button');
            btn.textContent = sub.name;
            btn.classList.add('w-full', 'text-left', 'px-3', 'py-2', 'rounded', 
                             'text-black', 'hover:bg-gray-200', 'transition-colors', 'text-sm');
            btn.onclick = () => {
                loadSubcategoryProducts(sub.id, sub.name);
                closeMobileMenu();
            };
            subList.appendChild(btn);
        }
        
        // Add "Te gjitha" button at the bottom
        const allBtn = document.createElement('button');
        allBtn.textContent = 'Te gjitha';
        allBtn.classList.add('w-full', 'text-left', 'px-3', 'py-2', 'rounded', 
                             'text-black', 'hover:bg-gray-200', 'transition-colors', 'text-sm', 'font-medium');
        allBtn.onclick = () => {
            loadCategoryProducts(category.id, category.name);
            closeMobileMenu();
        };
        subList.appendChild(allBtn);

        catDiv.appendChild(subList);
        container.appendChild(catDiv);
    }
}

function toggleMobileSubcategories(categoryId) {
    const subDiv = document.getElementById(`mobile-subcats-${categoryId}`);
    if (subDiv) {
        subDiv.classList.toggle('hidden');
    }
}

function toggleMobileMenu() {
    const menu = document.getElementById('mobile-menu');
    const overlay = document.getElementById('mobile-menu-overlay');
    const btn = document.getElementById('mobile-menu-btn');
    
    menu.classList.toggle('-translate-x-full');
    overlay.classList.toggle('hidden');
    
    // Change icon
    if (menu.classList.contains('-translate-x-full')) {
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>`;
    } else {
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>`;
        renderMobileCategories();
    }
}

function closeMobileMenu() {
    const menu = document.getElementById('mobile-menu');
    const overlay = document.getElementById('mobile-menu-overlay');
    const btn = document.getElementById('mobile-menu-btn');
    
    menu.classList.add('-translate-x-full');
    overlay.classList.add('hidden');
    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
    </svg>`;
}

function toggleSubcategories(categoryId) {
    const subDiv = document.getElementById(`subcats-${categoryId}`);
    if (subDiv) {
        subDiv.classList.toggle('hidden');
    }
}

// Load all products from a category
async function loadCategoryProducts(categoryId, categoryName) {
    try {
        // Hide banner when navigating to category
        const banner = document.getElementById('home-banner');
        if (banner) banner.classList.add('hidden');

        // First switch to home page if not already there
        if (currentPage !== 'home') {
            showPage('home', true);
        }
        
        // Find all subcategories in this category
        const category = categoriesData.find(cat => cat.id === categoryId);
        if (!category) return;
        
        let allProducts = [];
        
        // Fetch products from each subcategory
        for (const sub of category.subcategories) {
            const response = await fetch(`/api/subcategory/${sub.id}/products`);
            const products = await response.json();
            allProducts = allProducts.concat(products);
        }
        
        document.getElementById('products-title').textContent = categoryName;
        renderProducts(allProducts);
        
        // Show price range filter only
        showPriceOnlyFilters();
    } catch (error) {
        console.error('❌ Failed to load category products:', error);
        showNotification('Ngarkimi i produkteve deshtoi', 'error');
    }
}

// Show only price filter (for categories and brands)
function showPriceOnlyFilters() {
    currentSubcategoryId = null;
    priceRange = { min: 0, max: 20000 };
    
    document.getElementById('categories-section').style.display = 'none';
    document.getElementById('filters-section').style.display = 'block';
    
    const filtersContainer = document.getElementById('dynamic-filters');
    filtersContainer.innerHTML = '';
    filtersContainer.appendChild(createPriceRangeFilter());
    initializePriceSlider();
}

// ============================================
// PRODUCT LOADING
// ============================================
async function loadSubcategoryProducts(subcategoryId, subcategoryName) {
    try {
        // Scroll to top
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
        window.scrollTo(0, 0);

        // Hide banner when navigating to subcategory
        const banner = document.getElementById('home-banner');
        if (banner) banner.classList.add('hidden');

        // Switch to home page if not already there
        if (currentPage !== 'home' && currentPage !== 'subcategory') {
            showPage('home', false);
        }
        
        const response = await fetch(`/api/subcategory/${subcategoryId}/products`);
        const products = await response.json();
        
        document.getElementById('products-title').textContent = subcategoryName;
        renderProducts(products);
        
        console.log('✅ Subcategory loaded:', subcategoryName, products.length, 'products');
        
        // Load filters for this subcategory
        await loadSubcategoryFilters(subcategoryId);
        
        // UPDATE currentPage FIRST
        previousPage = currentPage;
        currentPage = 'subcategory';
        
        console.log('📄 CurrentPage updated:', previousPage, '→', currentPage);
        console.log('📄 Current window.history.state BEFORE push:', window.history.state);
        
        // ALWAYS add to history (unless coming from popstate)
        if (!window.isNavigatingHistory) {
            window.history.pushState({
                page: 'subcategory',
                subcategoryId: subcategoryId,
                subcategoryName: subcategoryName,
                timestamp: Date.now()
            }, '', `/#subcategory/${subcategoryId}/${encodeURIComponent(subcategoryName)}`);
            
            console.log('➕ Added to history: subcategory', subcategoryId, subcategoryName);
            console.log('📄 Current window.history.state AFTER push:', window.history.state);
        } else {
            console.log('⏭️ Skipped history add (navigating via popstate)');
        }
    } catch (error) {
        console.error('❌ Failed to load products:', error);
        showNotification('Ngarkimi i produkteve deshtoi', 'error');
    }
}

async function loadPopularProducts() {
    try {
        // Show banner on home page
        const banner = document.getElementById('home-banner');
        const bannerImg = document.getElementById('banner-image');
        if (banner && bannerImg && bannerImg.src) {
            banner.classList.remove('hidden');
        }
        const response = await fetch('/api/products/popular');
        const products = await response.json();
        
        document.getElementById('products-title').textContent = 'Të Fundit';
        renderProducts(products);
    } catch (error) {
        console.error('❌ Failed to load popular products:', error);
    }
}

function loadBrandsPage() {
    const brands = [
        'Volkswagen', 'BMW', 'Audi', 'Mercedes-Benz', 'Toyota', 'Ford', 
        'Skoda', 'Porsche', 'SEAT', 'Opel', 'Fiat', 'Range Rover', 
        'Tesla', 'Hyundai', 'Citroën', 'MINI', 'Honda', 'Peugeot', 
        'Renault', 'Nissan', 'Volvo', 'Mazda'
    ];
    
    const grid = document.getElementById('brands-grid');
    grid.innerHTML = '';
    
    brands.forEach(brand => {
        const brandSlug = brand.toLowerCase().replace(/\s+/g, '-').replace(/ë/g, 'e');
        const card = document.createElement('div');
        card.onclick = () => showBrandProducts(brand);
        card.className = 'bg-white border border-gray-200 rounded-lg p-4 text-center cursor-pointer hover:shadow-lg transition-shadow';
        
        card.innerHTML = `
            <div class="aspect-square mb-3 flex items-center justify-center bg-white rounded-lg overflow-hidden">
                <img src="/static/brands/${brandSlug}.png" 
                     alt="${brand}" 
                     class="w-full h-full object-contain p-2"
                     onerror="this.src='/static/brands/default.png'">
            </div>
            <h3 class="font-bold text-black text-sm">${brand}</h3>
        `;
        
        grid.appendChild(card);
    });
}

async function showBrandProducts(brandName) {
    try {
        // Hide pages first
        document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
        
        // Then scroll to top
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
        window.scrollTo(0, 0);
        
        const response = await fetch(`/api/brands/${encodeURIComponent(brandName)}/products`);
        const products = await response.json();
        document.getElementById('brand-products-page').style.display = 'block';
        const sidebar = document.getElementById('sidebar');
        if (sidebar) sidebar.style.display = 'none';

        // Hide mobile filters
        const mobileFiltersContainer = document.getElementById('mobile-filters-container');
        if (mobileFiltersContainer) mobileFiltersContainer.style.display = 'none';
        
        document.getElementById('brand-title').textContent = `Per ${brandName}`;
        
        const grid = document.getElementById('brand-products-grid');
        grid.innerHTML = '';
        
        if (products.length === 0) {
            grid.innerHTML = '<p class="col-span-full text-center text-gray-500">Nuk u gjeten produkte per kete marke.</p>';
            return;
        }
        
        products.forEach(product => {
            grid.appendChild(createProductCard(product));
        });
        
        console.log('✅ Brand products loaded:', brandName, products.length, 'products');

        // Only add to history if not coming from popstate
        if (!window.isNavigatingHistory) {
            previousPage = currentPage;
            currentPage = 'brand-products';
            window.history.pushState({ 
                page: 'brand-products', 
                brandName: brandName,
                timestamp: Date.now()
            }, '', `/#brand/${encodeURIComponent(brandName)}`);
            console.log('➕ Added to history: brand', brandName);
        } else {
            console.log('⏭️ Skipped history add (navigating via popstate)');
            currentPage = 'brand-products';
        }
        
        // Force scroll again
        setTimeout(() => {
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            window.scrollTo(0, 0);
        }, 0);
    } catch (error) {
        console.error('❌ Failed to load brand products:', error);
        showNotification('Dështoi ngarkimi i produkteve të markës', 'error');
    }
}

async function loadSpecialOffers() {
    const container = document.getElementById('offers-grid');
    container.innerHTML = '<p class="text-gray-500">Loading offers...</p>';
    
    try {
        const response = await fetch('/api/products/specials');
        const products = await response.json();
        
        if (!products || products.length === 0) {
            container.innerHTML = '<p class="text-gray-500 col-span-full text-center">Nuk ka oferta aktualisht.</p>';
            return;
        }
        
        container.innerHTML = '';
        products.forEach(product => {
            container.appendChild(createProductCard(product));
        });
    } catch (error) {
        console.error('❌ Failed to load special offers:', error);
        container.innerHTML = '<p class="text-gray-500">Gabim gjatë ngarkimit të ofertave.</p>';
    }
}

function renderProducts(products) {
    const container = document.getElementById('products-container');
    
    // Fade out
    container.style.opacity = '0';
    
    setTimeout(() => {
        container.innerHTML = '';
        
        if (products.length === 0) {
            container.innerHTML = '<p class="text-gray-500 col-span-full text-center">Nuk u gjeten produkte.</p>';
        } else {
            // Never hide actions - always show wishlist and cart buttons
            products.forEach(product => {
                container.appendChild(createProductCard(product, false));
            });
        }
        
        // Fade in
        container.style.opacity = '1';
    }, 50);
}

function createProductCard(product, hideActions = false) {
    const card = document.createElement('div');
    card.classList.add('bg-white', 'border', 'border-gray-200', 'rounded-xl', 
                       'p-4', 'shadow-sm', 'hover:shadow-md', 'transition-shadow', 
                       'cursor-pointer', 'product-card');
    
    // Extract values to avoid editor warnings
    const productId = product.id;
    const productName = product.name.replace(/'/g, "\\'"); // Escape quotes
    const productPrice = product.price;
    const productDiscountPrice = product.discount_price || product.price;
    const imageURL = product.main_image || '/static/uploads/default.png';
    const isSoldOut = product.sold_out || false;
    
    const isInWishlist = wishlistItems.some(item => item.productId === productId);
    const isInCart = cartItems.some(item => item.productId === productId);
    
    // Price display - side by side if discount
    let priceHTML = '';
    if (product.discount_price && product.discount_price < product.price) {
        priceHTML = `
            <div class="flex items-center justify-center space-x-2">
                <p class="text-red-700 font-bold text-base md:text-lg">${formatPrice(productDiscountPrice)}</p>
                <p class="text-xs md:text-sm text-gray-500 line-through">${formatPrice(productPrice)}</p>
            </div>
        `;
    } else {
        priceHTML = `<p class="text-red-700 font-bold text-base md:text-lg text-center">${formatPrice(productPrice)}</p>`;
    }
    
    // Action buttons (conditionally shown)
    let actionsHTML = '';
    if (!hideActions) {
        if (isSoldOut) {
            actionsHTML = `
                <div class="mt-3 bg-gray-100 py-3 rounded text-center">
                    <p class="text-gray-600 font-semibold text-sm">Sold Out</p>
                </div>
            `;
        } else {
            actionsHTML = `
                <div class="flex gap-2 mt-3">
                    <button
                        onclick="event.stopPropagation(); toggleWishlist(${productId}, '${productName}', ${productPrice}, '${imageURL}', ${isSoldOut})"
                        class="${isInWishlist ? 'bg-red-600 text-white' : 'bg-gray-200 text-black'} py-2 px-2.5 rounded hover:bg-red-700 hover:text-white transition-colors flex items-center justify-center flex-shrink-0"
                        title="${isInWishlist ? 'Hiq nga lista e dëshirave' : 'Shto ne listen e dëshirave'}"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="${isInWishlist ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                        </svg>
                    </button>
                    
                    <button
                        onclick="event.stopPropagation(); addToCart(${productId}, '${productName}', ${productDiscountPrice}, '${imageURL}', ${isSoldOut})"
                        class="flex-1 ${isInCart ? 'bg-green-600' : 'bg-red-600'} text-white py-2 rounded hover:bg-red-700 transition-colors flex items-center justify-center gap-1.5"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 md:w-5 md:h-5 ${isInCart ? 'hidden' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.2 6h12.8M10 19a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z"/>
                        </svg>
                        <span class="text-xs md:text-sm whitespace-nowrap">
                            ${isInCart ? '✓ Shtuar' : '<span class="md:hidden">Shto</span><span class="hidden md:inline">Shto ne Shporte</span>'}
                        </span>
                    </button>
                </div>
            `;
        }
    }
    
    card.innerHTML = `
        <div onclick="showProductDetail(${productId})" class="cursor-pointer flex-1 flex flex-col ${isSoldOut ? 'opacity-85' : ''}">
            <div class="aspect-square mb-3 flex items-center justify-center bg-white rounded-lg overflow-hidden relative">
                <img src="${imageURL}" alt="${productName}" class="w-full h-full object-contain p-2 ${isSoldOut ? 'grayscale opacity-60' : ''}">
                ${isSoldOut ? '<div class="absolute inset-0 flex items-center justify-center bg-grey bg-opacity-20"><span class="bg-red-600 text-white px-3 py-2 rounded-lg font-bold text-xs md:text-sm shadow-lg">SOLD OUT</span></div>' : ''}
            </div>
            <h4 class="font-semibold text-black mb-2 text-center text-sm md:text-base min-h-[40px] md:min-h-[24px] line-clamp-2 md:line-clamp-1">${productName}</h4>
            <div class="mt-auto">
                ${priceHTML}
            </div>
        </div>
        ${actionsHTML}
    `;
    
    return card;
}

// ============================================
// PRODUCT DETAIL
// ============================================
async function showProductDetail(productId) {
    try {
        // Hide all pages FIRST
        document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
        
        // Hide sidebar and mobile filters
        const sidebar = document.getElementById('sidebar');
        if (sidebar) sidebar.style.display = 'none';
        const mobileFiltersContainer = document.getElementById('mobile-filters-container');
        if (mobileFiltersContainer) mobileFiltersContainer.style.display = 'none';
        
        // Then scroll to top
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
        window.scrollTo(0, 0);

        const response = await fetch(`/api/product/${productId}`);
        const product = await response.json();
        
        console.log('📦 Product API response:', product);
  
        // Show product detail page
        document.getElementById('product-detail-page').style.display = 'block';

        const container = document.getElementById('product-detail-content');
        
        // SAVE CURRENT STATE BEFORE HIDING
        const wasOnHomePage = document.getElementById('home-page').style.display !== 'none';
        const currentProductsContainer = document.getElementById('products-container').innerHTML;
        const currentProductsTitle = document.getElementById('products-title').textContent;

        // UPDATE SEO META TAGS
        document.title = `${product.name} - Auto Adeal | Çmimi ${formatPrice(product.discount_price || product.price)}`;
        updateMetaTag('description', `Blej ${product.name} online. ${product.description || ''} Cmimi: ${formatPrice(product.discount_price || product.price)}. Dergesa ne Shqiperi dhe Kosove.`);
        updateMetaTag('og:title', `${product.name} - Auto Adeal`);
        updateMetaTag('og:description', product.description || `Blej ${product.name} me cmim te mire`);
        updateMetaTag('og:image', product.main_image || '/static/logo.png');
        updateMetaTag('og:url', `https://autoadeal.com/#product/${productId}`);
        
        const mainImageURL = product.main_image || '/static/uploads/default.png';
        const priceDisplay = product.discount_price && product.discount_price < product.price
            ? `<div class="flex items-center space-x-3">
                 <p class="text-red-700 font-bold text-3xl">${formatPrice(product.discount_price)}</p>
                 <p class="text-gray-500 line-through text-xl">${formatPrice(product.price)}</p>
               </div>`
            : `<p class="text-red-700 font-bold text-3xl">${formatPrice(product.price)}</p>`;
        
        // Build specs HTML
        let specsHTML = '';
        if (product.specs && Object.keys(product.specs).length > 0) {
            specsHTML = '<div class="mb-6"><h3 class="font-bold text-lg mb-3 text-black">Specifikimet</h3><div class="grid grid-cols-2 gap-3">';
            for (const [key, value] of Object.entries(product.specs)) {
                specsHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-600 mb-1">${key}</p>
                        <p class="text-sm font-semibold text-black">${value}</p>
                    </div>
                `;
            }
            specsHTML += '</div></div>';
        }
        
        // Additional images
        let additionalImagesHTML = '';
        if (product.images && product.images.length > 0) {
            additionalImagesHTML = `
                <div class="grid grid-cols-4 gap-3 mt-4">
                    ${product.images.slice(0, 4).map(img => `
                        <div class="aspect-square border-2 border-gray-200 rounded-lg overflow-hidden cursor-pointer hover:border-red-600 transition-colors" 
                             onclick="document.querySelector('#main-product-image').src='${img}'">
                            <img src="${img}" class="w-full h-full object-contain">
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        container.innerHTML = `
            <!-- Mobile: Title First -->
            <h1 class="text-xl font-bold text-black mb-4 lg:hidden">${product.name}</h1> 
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-12 mb-8 md:mb-12">
                <!-- Left side: Images -->
                <div class="flex items-center justify-center">
                    <div class="flex flex-col lg:flex-row items-center lg:items-start gap-4 max-w-[600px]">
                        <!-- Desktop: Thumbnails on left -->
                        ${product.images && product.images.length > 0 ? `
                            <div class="hidden lg:flex lg:flex-col gap-3" id="desktop-thumbnails">
                                ${product.images.slice(0, 4).map((img, idx) => `
                                    <div class="flex-shrink-0 aspect-square w-[112px] h-[112px] border-2 border-gray-200 rounded-lg overflow-hidden cursor-pointer hover:border-red-600 transition-colors bg-white" 
                                         style="min-width: 112px; min-height: 112px;"
                                         data-image="${img.replace(/"/g, '&quot;')}"
                                         data-thumb-index="${idx}">
                                        <img src="${img}" class="w-full h-full object-contain p-2" loading="lazy">
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="flex flex-col items-center gap-4 w-full">
                            <!-- Main image -->
                            <div class="aspect-square w-full max-w-[90vw] lg:w-[484px] lg:h-[484px] bg-white rounded-xl overflow-hidden flex items-center justify-center border border-gray-200 p-4 relative" style="min-height: 350px;">
                                <img id="main-product-image" src="${mainImageURL}" alt="${product.name}" class="w-full h-full object-contain ${product.sold_out ? 'grayscale opacity-50' : ''}" style="min-height: 300px;" loading="eager">
                                ${product.sold_out ? '<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20"><span class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg">SOLD OUT</span></div>' : ''}
                            </div>
                            
                            <!-- Mobile: Thumbnails below -->
                            ${product.images && product.images.length > 0 ? `
                                <div class="grid grid-cols-4 gap-2 w-full max-w-[90vw] lg:hidden" id="mobile-thumbnails">
                                    ${product.images.slice(0, 4).map((img, idx) => `
                                        <div class="aspect-square border-2 border-gray-200 rounded-lg overflow-hidden cursor-pointer hover:border-red-600 transition-colors bg-white"
                                             style="min-height: 80px;"
                                             data-image="${img.replace(/"/g, '&quot;')}"
                                             data-thumb-index="${idx}">
                                            <img src="${img}" class="w-full h-full object-contain p-1" loading="lazy">
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Right side: Product details -->
                <div>
                    <h1 class="hidden lg:block text-3xl font-bold text-black mb-4">${product.name}</h1>
                    <div class="mb-6">${priceDisplay}</div>
                    
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-2 text-black">Pershkrimi</h3>
                        <p class="text-gray-700 leading-relaxed">${product.description || 'Nuk ka pershkrim te disponueshem.'}</p>
                    </div>
                    
                    ${specsHTML}
                    
                    <div class="flex space-x-4 mt-8">
                        ${product.sold_out ? `
                            <div class="flex-1 bg-gray-400 text-white px-6 py-4 rounded-lg text-center font-bold text-lg cursor-not-allowed">
                                SOLD OUT - Not Available
                            </div>
                        ` : `
                            <button onclick="toggleWishlist(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price}, '${mainImageURL}')" 
                                    class="border-2 border-red-600 text-red-600 px-6 py-3 rounded-lg hover:bg-red-50 transition-colors flex items-center space-x-2 font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                                <span>Deshirat</span>
                            </button>
                            <button onclick="addToCart(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.discount_price || product.price}, '${mainImageURL}')" 
                                    class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2 font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.2 6h12.8M10 19a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z"/>
                                </svg>
                                <span>Shto ne Shporte</span>
                            </button>
                        `}
                    </div>
                </div>
            </div>
            
            ${product.related && product.related.length > 0 ? `
                <div class="mt-16">
                    <h3 class="text-2xl font-bold text-black mb-6">Produkte te Ngjashme</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 items-stretch">
                        ${product.related.map(r => {
                            const rImageURL = r.main_image || '/static/uploads/default.png';
                            const rPriceDisplay = r.discount_price && r.discount_price < r.price
                                ? `<div class="flex items-center space-x-2">
                                     <p class="text-red-700 font-semibold">${formatPrice(r.discount_price)}</p>
                                     <p class="text-xs text-gray-500 line-through">${formatPrice(r.price)}</p>
                                   </div>`
                                : `<p class="text-red-700 font-semibold">${formatPrice(r.price)}</p>`;
                            
                            return `
                                <div onclick="showProductDetail(${r.id})" class="cursor-pointer border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow bg-white flex flex-col h-full">
                                    <div class="aspect-square bg-white rounded-lg overflow-hidden mb-3 flex-shrink-0">
                                        <img src="${rImageURL}" class="w-full h-full object-contain">
                                    </div>
                                    <h4 class="font-semibold text-black mb-2 text-sm text-center line-clamp-2">${r.name}</h4>
                                    <div class="mt-auto pt-2">
                                        ${rPriceDisplay}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
        `;

        // ADD PRODUCT SCHEMA FOR GOOGLE
        const schema = {
            "@context": "https://schema.org/",
            "@type": "Product",
            "name": product.name,
            "image": product.main_image || '/static/logo.png',
            "description": product.description || product.name,
            "sku": `PROD-${product.id}`,
            "brand": {
                "@type": "Brand",
                "name": "Auto Adeal"
            },
            "offers": {
                "@type": "Offer",
                "url": `https://autoadeal.com/#product/${product.id}`,
                "priceCurrency": "ALL",
                "price": product.discount_price || product.price,
                "availability": product.sold_out ? "https://schema.org/OutOfStock" : "https://schema.org/InStock",
                "seller": {
                    "@type": "Organization",
                    "name": "Auto Adeal"
                }
            }
        };
        
        // Remove old schema if exists
        const oldSchema = document.getElementById('product-schema');
        if (oldSchema) oldSchema.remove();
        
        // Add new schema
        const script = document.createElement('script');
        script.id = 'product-schema';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(schema);
        document.head.appendChild(script);
        
        console.log('✅ Product detail loaded:', product.name || product.product_name);

        // Attach thumbnail click handlers
        setTimeout(() => {
            const mainImage = document.getElementById('main-product-image');
            
            // Desktop thumbnails
            const desktopThumbs = document.querySelectorAll('#desktop-thumbnails > div[data-image]');
            desktopThumbs.forEach(thumb => {
                thumb.addEventListener('click', function() {
                    const imgSrc = this.getAttribute('data-image');
                    if (mainImage && imgSrc) {
                        mainImage.src = imgSrc;
                    }
                });
            });
            
            // Mobile thumbnails
            const mobileThumbs = document.querySelectorAll('#mobile-thumbnails > div[data-image]');
            mobileThumbs.forEach(thumb => {
                thumb.addEventListener('click', function() {
                    const imgSrc = this.getAttribute('data-image');
                    if (mainImage && imgSrc) {
                        mainImage.src = imgSrc;
                    }
                });
            });
        }, 100);
          
        // Attach back button handler
        setTimeout(() => {
            const backBtn = document.getElementById('product-back-btn');
            if (backBtn) {
                backBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔙 Back button clicked from product page');
                    console.log('   Current history state:', window.history.state);
                    console.log('   History length:', window.history.length);
                    window.history.back();
                });
                console.log('✅ Back button handler attached');
            }
        }, 100);

        // Handle history
        if (!window.isNavigatingHistory) {
            // Save the current page state before navigating
            const previousState = window.history.state;
            console.log('💾 Previous state before product:', previousState);
            
            previousPage = currentPage;
            currentPage = 'product-detail';
            
            // Push product to history
            window.history.pushState({ 
                page: 'product-detail', 
                productId: productId,
                from: previousPage,
                previousState: previousState, // Save previous state for reference
                timestamp: Date.now()
            }, '', `/#product/${productId}`);
            console.log('➕ Added to history: product', productId, 'from', previousPage);
        } else {
            console.log('⏭️ Skipped history update (navigating via popstate)');
            currentPage = 'product-detail';
        }
        
        // Force scroll to top again
        setTimeout(() => {
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            window.scrollTo(0, 0);
        }, 0);
    } catch (error) {
        console.error('❌ Failed to load product detail:', error);
        showNotification('Dështoi ngarkimi i detajeve të produktit', 'error');
    }
}

// ============================================
// CART FUNCTIONALITY
// ============================================
function loadCartFromStorage() {
    try {
        const stored = localStorage.getItem('auto_adeal_cart');
        if (stored) {
            cartItems = JSON.parse(stored);
            console.log(`📦 Loaded ${cartItems.length} items from cart`);
        } else {
            cartItems = [];
        }
    } catch (e) {
        console.error('Error loading cart:', e);
        cartItems = [];
    }
}

function saveCartToStorage() {
    localStorage.setItem('auto_adeal_cart', JSON.stringify(cartItems));
}

function addToCart(productId, productName, productPrice, productImage, isSoldOut = false) {
    // Prevent adding sold out products
    if (isSoldOut) {
        showNotification('Ky Produkt Eshte Shitur', 'error');
        return;
    }
    
    // Check if already in cart
    const existingItem = cartItems.find(item => item.productId === productId);
    
    if (existingItem) {
        existingItem.quantity += 1;
        showNotification('U Ndryshua Sasia ne Shporte', 'success');
    } else {
        cartItems.push({
            productId,
            productName,
            productPrice,
            productImage,
            quantity: 1
        });
        showNotification('U Shtua ne Shporte!', 'success');
    }
    
    saveCartToStorage();
    updateCartCount();
    
    // Re-render if on cart page
    if (currentPage === 'cart') {
        loadCartPage();
    }
    
    // Re-render product cards to show "Added" state
    if (currentPage === 'home' || currentPage.includes('subcategory')) {
        const currentProducts = document.getElementById('products-container').children;
        // Just update the button text for this product
        // (Full re-render would reset scroll position)
    }
}

function removeFromCart(productId) {
    cartItems = cartItems.filter(item => item.productId !== productId);
    saveCartToStorage();
    updateCartCount();
    loadCartPage();
    showNotification('U hoq nga Shporta', 'success');
}

function updateCartQuantity(productId, newQuantity) {
    if (newQuantity <= 0) {
        removeFromCart(productId);
        return;
    }
    
    const item = cartItems.find(i => i.productId === productId);
    if (item) {
        item.quantity = newQuantity;
        saveCartToStorage();
        loadCartPage();
    }
}

function updateCartCount() {
    const count = cartItems.length;
    document.getElementById('cart-count').textContent = count;
    const mobileCount = document.getElementById('cart-count-mobile');
    if (mobileCount) mobileCount.textContent = count;
}

function loadCartPage() {
    const cartContent = document.getElementById('cart-content');
    
    if (cartItems.length === 0) {
        cartContent.innerHTML = `
            <div class="text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 mx-auto mb-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.2 6h12.8M10 19a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z"/>
                </svg>
                <h2 class="text-2xl font-bold text-black mb-2">Shporta jote është bosh</h2>
                <p class="text-gray-600 mb-6">Shto produkte për të filluar!</p>
                <button onclick="showPage('home'); loadPopularProducts();" class="bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700 transition-colors">
                    Fillo Blerjet
                </button>
            </div>
        `;
        return;
    }
    
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    
    cartContent.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-gray-200">
                        <h2 class="text-lg md:text-xl font-bold text-black">Produktet ne Shporte (${cartItems.length})</h2>
                    </div>
                    <div class="divide-y divide-gray-200">
                        ${cartItems.map(item => `
                            <div class="p-4 md:p-6" data-product-id="${item.productId}">
                                <!-- Mobile Layout -->
                                <div class="flex md:hidden space-x-3">
                                    <img src="${item.productImage}" class="w-20 h-20 object-contain rounded flex-shrink-0">
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-bold text-black text-sm mb-1">${item.productName.split(' - ')[0]}</h3>
                                        <p class="text-red-600 font-bold text-base mb-3">${formatPrice(item.productPrice)}</p>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="updateCartQuantity(${item.productId}, ${item.quantity - 1})" 
                                                    class="w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors flex items-center justify-center">
                                                <span class="text-lg leading-none">-</span>
                                            </button>
                                            <span class="w-10 text-center font-medium">${item.quantity}</span>
                                            <button onclick="updateCartQuantity(${item.productId}, ${item.quantity + 1})" 
                                                    class="w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors flex items-center justify-center">
                                                <span class="text-lg leading-none">+</span>
                                            </button>
                                            <button onclick="removeFromCart(${item.productId})" 
                                                    class="ml-2 text-red-600 hover:text-red-700 text-sm font-medium px-2">
                                                Hiq
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Desktop Layout -->
                                <div class="hidden md:flex items-center space-x-4">
                                    <img src="${item.productImage}" class="w-20 h-20 object-contain rounded">
                                    <div class="flex-1">
                                        <h3 class="font-bold text-black">${item.productName}</h3>
                                        <p class="text-red-600 font-bold">${formatPrice(item.productPrice)}</p>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <button onclick="updateCartQuantity(${item.productId}, ${item.quantity - 1})" 
                                                class="w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">-</button>
                                        <span class="w-12 text-center font-medium">${item.quantity}</span>
                                        <button onclick="updateCartQuantity(${item.productId}, ${item.quantity + 1})" 
                                                class="w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">+</button>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-black">${formatPrice(item.productPrice * item.quantity)}</p>
                                        <button onclick="removeFromCart(${item.productId})" 
                                                class="text-red-600 hover:text-red-700 text-sm mt-1">Hiq</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                <div class="bg-white border border-gray-200 rounded-lg p-6 sticky top-6">
                    <h2 class="text-xl font-bold text-black mb-4">Përmbledhja e Porosisë</h2>
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Nëntotali (${cartItems.length} produkte)</span>
                            <span class="font-medium text-black">${formatPrice(subtotal)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Dërgesa</span>
                            <span class="text-gray-600">Llogaritet ne Checkout</span>
                        </div>
                        <hr class="my-3">
                        <div class="flex justify-between text-lg">
                            <span class="font-bold text-black">Totali</span>
                            <span class="font-bold text-black">${formatPrice(subtotal)}</span>
                        </div>
                    </div>
                    <button onclick="showPage('checkout')" 
                            class="w-full bg-red-600 text-white py-3 rounded hover:bg-red-700 transition-colors mb-3">
                        Vazhdo te pagesa
                    </button>
                    <button onclick="showPage('home'); loadPopularProducts();" 
                            class="w-full bg-gray-200 text-black py-3 rounded hover:bg-gray-300 transition-colors">
                        Shto Produkte
                    </button>
                </div>
            </div>
        </div>
    `;
}

// ============================================
// WISHLIST FUNCTIONALITY
// ============================================
function loadWishlistFromStorage() {
    try {
        const stored = localStorage.getItem('auto_adeal_wishlist');
        if (stored) {
            wishlistItems = JSON.parse(stored);
            console.log(`❤️ Loaded ${wishlistItems.length} items from wishlist`);
        } else {
            wishlistItems = [];
        }
    } catch (e) {
        console.error('Error loading wishlist:', e);
        wishlistItems = [];
    }
}

function saveWishlistToStorage() {
    localStorage.setItem('auto_adeal_wishlist', JSON.stringify(wishlistItems));
}

function toggleWishlist(productId, productName, productPrice, productImage, isSoldOut = false) {
    // Prevent adding sold out products to wishlist
    if (isSoldOut) {
        showNotification('Ky produkt eshte shitur', 'error');
        return;
    }
    
    const existingIndex = wishlistItems.findIndex(item => item.productId === productId);
    
    if (existingIndex !== -1) {
        wishlistItems.splice(existingIndex, 1);
        showNotification('U hoq nga Lista', 'success');
    } else {
        wishlistItems.push({
            productId,
            productName,
            productPrice,
            productImage
        });
        showNotification('U Shtua ne Liste!', 'success');
    }
    
    saveWishlistToStorage();
    updateWishlistCount();
    
    // Re-render if on wishlist page
    if (currentPage === 'wishlist') {
        loadWishlistPage();
    }
}

function updateWishlistCount() {
    const count = wishlistItems.length;
    document.getElementById('wishlist-count').textContent = count;
    const mobileCount = document.getElementById('wishlist-count-mobile');
    if (mobileCount) mobileCount.textContent = count;
}

function loadWishlistPage() {
    const grid = document.getElementById('wishlist-grid');
    grid.innerHTML = '';
    
    if (wishlistItems.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 mx-auto mb-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
                <h2 class="text-2xl font-bold text-black mb-2">Lista e dëshirave është bosh</h2>
                <p class="text-gray-600 mb-6">Ruaj produktet e tua të preferuara këtu!</p>
                <button onclick="showPage('home'); loadPopularProducts();" class="bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700 transition-colors">
                    Fillo Blerjet
                </button>
            </div>
        `;
        return;
    }
    
    wishlistItems.forEach(item => {
        const card = document.createElement('div');
        card.classList.add('bg-white', 'border', 'border-gray-200', 'rounded-xl', 
                          'p-4', 'shadow-sm', 'hover:shadow-md', 'transition-shadow');
        
        const isInCart = cartItems.some(cartItem => cartItem.productId === item.productId);
        
        card.innerHTML = `
            <div onclick="showProductDetail(${item.productId})" class="cursor-pointer">
                <img src="${item.productImage}" alt="${item.productName}" class="w-full h-40 object-contain mb-4 rounded">
                <h4 class="font-semibold text-black mb-2">${item.productName}</h4>
                <p class="text-red-700 font-bold text-lg mb-4">${formatPrice(item.productPrice)}</p>
            </div>
            
            <div class="flex space-x-2">
                <button
                    onclick="event.stopPropagation(); toggleWishlist(${item.productId}, '${item.productName}', ${item.productPrice}, '${item.productImage}')"
                    class="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors"
                >
                    Hiq
                </button>
                <button
                    onclick="event.stopPropagation(); addToCart(${item.productId}, '${item.productName}', ${item.productPrice}, '${item.productImage}')"
                    class="flex-1 ${isInCart ? 'bg-green-600' : 'bg-gray-600'} text-white py-2 rounded hover:bg-gray-700 transition-colors"
                >
                    ${isInCart ? '✓ Ne Shporte' : 'Shto ne Shporte'}
                </button>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

// ============================================
// CHECKOUT
// ============================================
function loadCheckoutSummary() {
    const summary = document.getElementById('checkout-summary');
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    
    summary.innerHTML = `
        <div class="space-y-3">
            ${cartItems.map(item => `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-medium text-black">${item.productName}</p>
                        <p class="text-gray-600 text-sm">Sasia: ${item.quantity}</p>
                    </div>
                    <p class="font-medium text-black">${formatPrice(item.productPrice * item.quantity)}</p>
                </div>
            `).join('')}
            
            <hr class="my-3">
            
            <div class="flex justify-between">
                <p class="font-medium text-black">Nëntotali:</p>
                <p class="font-medium text-black">${formatPrice(subtotal)}</p>
            </div>
            
            <div class="flex justify-between">
                <p class="font-medium text-black">Dërgesa:</p>
                <p class="font-medium text-black" id="shipping-cost">Zgjidh Shtetin</p>
            </div>
            
            <hr class="my-3">
            
            <div class="flex justify-between text-lg">
                <p class="font-bold text-black">Totali:</p>
                <p class="font-bold text-black" id="total-cost">${formatPrice(subtotal)}</p>
            </div>
        </div>
    `;
}

function updateShipping() {
    const country = document.getElementById('checkout-country').value;
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    let shippingCost = 0;
    
    if (country === 'Albania') {
        shippingCost = 300; // Always in ALL
    } else if (country === 'Kosovo') {
        shippingCost = 700; // Always in ALL
    }
    
    const shippingElement = document.getElementById('shipping-cost');
    const totalElement = document.getElementById('total-cost');
    
    if (shippingElement) {
        shippingElement.textContent = shippingCost > 0 ? formatPrice(shippingCost) : 'Select country';
    }
    
    if (totalElement) {
        totalElement.textContent = formatPrice(subtotal + shippingCost);
    }
}

function processOrder(event) {
    event.preventDefault();
    
    const name = document.getElementById('checkout-name').value;
    const phone = document.getElementById('checkout-phone').value;
    const country = document.getElementById('checkout-country').value;
    const city = document.getElementById('checkout-city').value;
    
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    let shippingCost = 0;
    
    if (country === 'Albania') {
        shippingCost = 300; // Always in ALL
    } else if (country === 'Kosovo') {
        shippingCost = 700; // Always in ALL
    }
    
    const total = subtotal + shippingCost;
    
    // Store order (you can send this to backend later)
    const order = {
        orderName: name,
        orderPhone: phone,
        orderCountry: country,
        orderCity: city,
        orderTotal: total,
        orderItems: cartItems,
        orderDate: new Date().toISOString()
    };
    
    console.log('Order placed:', order);
    
    // Clear cart
    cartItems = [];
    saveCartToStorage();
    updateCartCount();
    
    showNotification('Porosia u bë me sukses! Do të merrni një telefonatë ose mesazh për të konfirmuar dorëzimin.', 'success');
    showPage('home');
    loadPopularProducts();
}

// ============================================
// DYNAMIC FILTERS
// ============================================
let currentSubcategoryId = null;
let currentFilters = {};
let priceRange = { min: 0, max: 20000 };

// Predefined filter choices for Albanian specifications
const filterChoices = {
    'E pershtatshme per': ['Volkswagen', 'BMW', 'Audi', 'Mercedes-Benz', 'Toyota', 'Ford', 'Skoda', 'Porsche', 'SEAT', 'Opel', 'Fiat', 'Range Rover', 'Tesla', 'Hyundai', 'Cintroen', 'MINI', 'Honda', 'Peugeot', 'Renault', 'Nissan', 'Volvo', 'Mazda'],
    'Pozicioni': ['Para Majtas', 'Para Djathtas', 'Mbrapa Majtas', 'Mbrapa Djathtas', 'Set'],
    'Sasia': ['30ml', '50ml', '60ml'],
    'Pjesa': ['Mbulese', 'Koke', 'Set'],
    'Ngjyra': ['E zeze', 'E bardhe', 'Bezhe', 'Gri', 'Kafe'],
    'Lloji i Bazes': ['H7', 'H4', 'H1', 'H11', 'W5W', 'P21W'],
    'Lloji i Llampes': ['LED', 'Halogjen', 'Xenon'],
    'Perdorimi': ['Te Gjata', 'Te Shkurtra', 'Stopa', 'Sinjale', 'Drita Mjegulle', 'Drita te Brendshme'],
    'Ngjyra e Drites': ['E bardhe', 'E kuqe', 'Portokalli'],
    'Temperatura e Ngjyres': ['3000K', '4300K', '6000K'],
    'Prodhuesi': ['Castrol', 'Liqui Moly', 'Motul', 'Shell', 'Mobil', 'Valvoline', 'Amsoil', 'Motul', 'Tjeter'],
    'Kapaciteti': ['1L', '2L', '4L', '5L+'],
    'Lloji i Motorit': ['Nafte', 'Benzine', 'Gaz', 'Hybrid'],
    'Lloji i Ftohesit': ['G11', 'G12', 'G12+', 'G13'],
    'Ngjyra e Ftohesit': ['E kuqe', 'Blu', 'Jeshile', 'Portokalli', 'Roze', 'E verdhe', 'Tjeter'],
    'Vleresimi DOT': ['DOT3', 'DOT4', 'DOT5', 'DOT5.1'],
    'Viscosity': ['5w30', '5w40', '0w40', '10w30', '75w80', '75w90', 'Tjeter'],
    'Materiali': ['Cope', 'Gomine', 'Lekure PU']
};

async function loadSubcategoryFilters(subcategoryId) {
    currentSubcategoryId = subcategoryId;
    currentFilters = {};
    priceRange = { min: 0, max: 20000 };
    
    try {
        const response = await fetch(`/api/subcategory/${subcategoryId}/specs`);
        const specs = await response.json();
        
        // Show filters section
        // Show filters section (desktop only)
        if (window.innerWidth >= 768) {
            document.getElementById('categories-section').style.display = 'none';
            document.getElementById('filters-section').style.display = 'block';
        }
        
        // Render filters
        const filtersContainer = document.getElementById('dynamic-filters');
        filtersContainer.innerHTML = '';
        
        // ALWAYS add price range filter first
        filtersContainer.appendChild(createPriceRangeFilter());
        
        // Add other filters from database
        specs.forEach(spec => {
            const filterDiv = document.createElement('div');
            filterDiv.classList.add('mb-4');
            
            const label = document.createElement('label');
            label.classList.add('block', 'text-sm', 'font-medium', 'text-black', 'mb-2');
            label.textContent = spec.name;
            filterDiv.appendChild(label);
            
            // Check if we have predefined choices for this spec
            const choices = filterChoices[spec.name] || spec.choices || [];
            
            if (choices.length > 0) {
                const select = document.createElement('select');
                select.classList.add('w-full', 'px-3', 'py-2', 'border', 'border-gray-300', 'rounded', 'text-black', 'text-sm');
                select.id = `filter-${spec.id}`;
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `Zgjidh`;
                select.appendChild(defaultOption);
                
                choices.forEach(choice => {
                    const option = document.createElement('option');
                    const choiceValue = typeof choice === 'string' ? choice.trim() : choice;
                    option.value = choiceValue;
                    option.textContent = choiceValue;
                    select.appendChild(option);
                });
                
                filterDiv.appendChild(select);
            } else {
                // Fallback to text input if no choices defined
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `filter-${spec.id}`;
                input.placeholder = `Kerko sipas ${spec.name}`;
                input.classList.add('w-full', 'px-3', 'py-2', 'border', 'border-gray-300', 'rounded', 'text-black', 'text-sm');
                filterDiv.appendChild(input);
            }
            
            filtersContainer.appendChild(filterDiv);
        });
        
        // Initialize price slider
        initializePriceSlider();

        // Also load mobile filters
        await loadMobileFilters(subcategoryId);
        
    } catch (error) {
        console.error('❌ Failed to load filters:', error);
    }
}

function toggleMobileFilters() {
    const panel = document.getElementById('mobile-filters-panel');
    const arrow = document.getElementById('mobile-filters-arrow');
    
    panel.classList.toggle('hidden');
    arrow.classList.toggle('rotate-180');
}

async function loadMobileFilters(subcategoryId) {
    // Only run on mobile
    if (window.innerWidth >= 768) {
        return;
    }
    
    const container = document.getElementById('mobile-dynamic-filters');
    const toggleButton = document.getElementById('mobile-filters-toggle');
    const mobileFiltersContainer = document.getElementById('mobile-filters-container');
    
    if (!subcategoryId) {
        if (toggleButton) toggleButton.style.display = 'none';
        if (mobileFiltersContainer) mobileFiltersContainer.style.display = 'none';
        return;
    }
    
    if (mobileFiltersContainer) mobileFiltersContainer.style.display = 'block';
    if (toggleButton) toggleButton.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/subcategory/${subcategoryId}/specs`);
        const specs = await response.json();
        
        container.innerHTML = '';
        
        // Always add price filter
        container.appendChild(createMobilePriceFilter());
        
        // Add other filters
        specs.forEach(spec => {
            const div = document.createElement('div');
            div.className = 'space-y-2';
            
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-gray-700';
            label.textContent = spec.name;
            div.appendChild(label);
            
            if (spec.choices && spec.choices.length > 0) {
                        // For brands, use multi-select instead
                        if (spec.name === 'E pershtatshme per') {
                            const select = document.createElement('select');
                            select.multiple = true;
                            select.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-transparent';
                            select.dataset.spectypeId = spec.id;
                            select.style.height = '120px';
                            
                            spec.choices.forEach(choice => {
                                const option = document.createElement('option');
                                option.value = choice.trim();
                                option.textContent = choice.trim();
                                select.appendChild(option);
                            });
                            
                            const helperText = document.createElement('p');
                            helperText.className = 'text-xs text-gray-500 mt-1';
                            helperText.textContent = 'Hold Ctrl (Cmd on Mac) to select multiple brands';
                            
                            div.appendChild(select);
                            div.appendChild(helperText);
                        } else {
                            const select = document.createElement('select');
                            select.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-transparent';
                            select.dataset.spectypeId = spec.id;
                            
                            const defaultOption = document.createElement('option');
                            defaultOption.value = '';
                            defaultOption.textContent = `Select ${spec.name}`;
                            select.appendChild(defaultOption);
                            
                            spec.choices.forEach(choice => {
                                const option = document.createElement('option');
                                option.value = choice.trim();
                                option.textContent = choice.trim();
                                select.appendChild(option);
                            });
                            
                            div.appendChild(select);
                        }
            } else {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-transparent text-sm';
                input.dataset.spectypeId = spec.id;
                input.placeholder = `Enter ${spec.name}`;
                div.appendChild(input);
            }
            
            container.appendChild(div);
        });
    } catch (error) {
        console.error('Failed to load mobile filters:', error);
    }
}

function createMobilePriceFilter() {
    const filterDiv = document.createElement('div');
    filterDiv.className = 'mb-4 pb-4 border-b border-gray-200';
    
    filterDiv.innerHTML = `
        <label class="block text-sm font-medium text-gray-700 mb-3">Cmimi (ALL)</label>
        
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="text-xs text-gray-600 mb-1 block">Nga:</label>
                <input type="number" id="mobile-min-price-input" value="0" min="0" max="20000" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-black text-sm">
            </div>
            <div>
                <label class="text-xs text-gray-600 mb-1 block">Deri:</label>
                <input type="number" id="mobile-max-price-input" value="20000" min="0" max="20000" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-black text-sm">
            </div>
        </div>
    `;
    
    return filterDiv;
}

async function applyMobileFilters() {
    if (!currentSubcategoryId) return;
    
    // Get price range
    const minPrice = parseInt(document.getElementById('mobile-min-price-input').value) || 0;
    const maxPrice = parseInt(document.getElementById('mobile-max-price-input').value) || 20000;
    priceRange = { min: minPrice, max: maxPrice };
    
    // Get spec filters
    const filterInputs = document.querySelectorAll('#mobile-dynamic-filters select, #mobile-dynamic-filters input[type="text"]');
    currentFilters = {};
    
    filterInputs.forEach(input => {
        if (input.value && input.dataset.spectypeId) {
            const specId = input.dataset.spectypeId;
            currentFilters[specId] = input.value.toLowerCase();
        }
    });
    
    // Apply filters (reuse desktop logic)
    const response = await fetch(`/api/subcategory/${currentSubcategoryId}/products`);
    let products = await response.json();
    
    // Apply price range filter
    products = products.filter(product => {
        const price = product.discount_price || product.price;
        return price >= priceRange.min && price <= priceRange.max;
    });
    
    // Apply spec filters
    if (Object.keys(currentFilters).length > 0) {
        products = products.filter(product => {
            for (const [specId, filterValue] of Object.entries(currentFilters)) {
                const filterElement = document.querySelector(`#mobile-dynamic-filters [data-spectype-id="${specId}"]`);
                if (!filterElement || !filterElement.previousElementSibling) continue;
                
                const specName = filterElement.previousElementSibling.textContent;
                const productSpecValue = product.specs[specName];
                
                if (!productSpecValue || !productSpecValue.toLowerCase().includes(filterValue)) {
                    return false;
                }
            }
            return true;
        });
    }
    
    renderProducts(products);
    showNotification(`${products.length} produkte u gjeten`, 'success');
    
    // Close filters panel
    document.getElementById('mobile-filters-panel').classList.add('hidden');
    document.getElementById('mobile-filters-arrow').classList.remove('rotate-180');
}

function createPriceRangeFilter() {
    const filterDiv = document.createElement('div');
    filterDiv.classList.add('mb-6', 'pb-4', 'border-b', 'border-gray-200');
    
    filterDiv.innerHTML = `
        <label class="block text-sm font-medium text-black mb-3">Cmimi (ALL)</label>
        
        <!-- Slider Container -->
        <div class="relative h-2 bg-gray-200 rounded-full mb-4" id="price-slider">
            <div id="price-track" class="absolute h-2 bg-red-600 rounded-full"></div>
            <div id="min-thumb" class="absolute w-5 h-5 bg-red-600 border-2 border-white rounded-full cursor-pointer shadow-md" style="top: -6px;"></div>
            <div id="max-thumb" class="absolute w-5 h-5 bg-red-600 border-2 border-white rounded-full cursor-pointer shadow-md" style="top: -6px;"></div>
        </div>
        
        <!-- Input Fields -->
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="text-xs text-gray-600 mb-1 block">Nga:</label>
                <input type="number" id="min-price-input" value="0" min="0" max="20000" 
                       class="w-full px-3 py-2 border border-gray-300 rounded text-black text-sm">
            </div>
            <div>
                <label class="text-xs text-gray-600 mb-1 block">Deri:</label>
                <input type="number" id="max-price-input" value="20000" min="0" max="20000" 
                       class="w-full px-3 py-2 border border-gray-300 rounded text-black text-sm">
            </div>
        </div>
    `;
    
    return filterDiv;
}

function initializePriceSlider() {
    const slider = document.getElementById('price-slider');
    const track = document.getElementById('price-track');
    const minThumb = document.getElementById('min-thumb');
    const maxThumb = document.getElementById('max-thumb');
    const minInput = document.getElementById('min-price-input');
    const maxInput = document.getElementById('max-price-input');
    
    if (!slider || !track || !minThumb || !maxThumb) return;
    
    let isDragging = false;
    let activeThumb = null;
    
    function updateSlider() {
        const sliderWidth = slider.offsetWidth;
        const minPercent = (priceRange.min / 20000) * 100;
        const maxPercent = (priceRange.max / 20000) * 100;
        
        minThumb.style.left = `calc(${minPercent}% - 10px)`;
        maxThumb.style.left = `calc(${maxPercent}% - 10px)`;
        
        track.style.left = `${minPercent}%`;
        track.style.width = `${maxPercent - minPercent}%`;
        
        minInput.value = priceRange.min;
        maxInput.value = priceRange.max;
    }
    
    function handleMouseDown(e, thumb) {
        isDragging = true;
        activeThumb = thumb;
        e.preventDefault();
        document.body.style.userSelect = 'none';
    }
    
    function handleMouseMove(e) {
        if (!isDragging || !activeThumb) return;
        
        const rect = slider.getBoundingClientRect();
        const percent = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
        const value = Math.round((percent / 100) * 20000);
        
        if (activeThumb === minThumb) {
            priceRange.min = Math.min(value, priceRange.max - 100);
        } else {
            priceRange.max = Math.max(value, priceRange.min + 100);
        }
        
        updateSlider();
    }
    
    function handleMouseUp() {
        isDragging = false;
        activeThumb = null;
        document.body.style.userSelect = '';
    }
    
    function handleTouchStart(e, thumb) {
        handleMouseDown(e.touches[0], thumb);
    }
    
    function handleTouchMove(e) {
        if (!isDragging) return;
        e.preventDefault();
        handleMouseMove(e.touches[0]);
    }
    
    // Mouse events
    minThumb.addEventListener('mousedown', (e) => handleMouseDown(e, minThumb));
    maxThumb.addEventListener('mousedown', (e) => handleMouseDown(e, maxThumb));
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    
    // Touch events for mobile
    minThumb.addEventListener('touchstart', (e) => handleTouchStart(e, minThumb));
    maxThumb.addEventListener('touchstart', (e) => handleTouchStart(e, maxThumb));
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleMouseUp);
    
    // Input field handlers
    minInput.addEventListener('input', (e) => {
        const value = parseInt(e.target.value) || 0;
        priceRange.min = Math.max(0, Math.min(value, priceRange.max - 100));
        updateSlider();
    });
    
    maxInput.addEventListener('input', (e) => {
        const value = parseInt(e.target.value) || 20000;
        priceRange.max = Math.min(20000, Math.max(value, priceRange.min + 100));
        updateSlider();
    });
    
    // Initialize slider position
    updateSlider();
}

function showCategories() {
    // Only show on desktop
    if (window.innerWidth >= 768) {
        document.getElementById('categories-section').style.display = 'block';
        document.getElementById('filters-section').style.display = 'none';
    }
    currentSubcategoryId = null;
}

async function applyFilters() {
    if (!currentSubcategoryId) return;
    
    // Get all filter values
    const filterInputs = document.querySelectorAll('#dynamic-filters select, #dynamic-filters input[type="text"]');
    currentFilters = {};
    
    filterInputs.forEach(input => {
        if (input.value && input.id.startsWith('filter-')) {
            const specId = input.id.replace('filter-', '');
            currentFilters[specId] = input.value.toLowerCase();
        }
    });
    
    // Fetch products
    const response = await fetch(`/api/subcategory/${currentSubcategoryId}/products`);
    let products = await response.json();
    
    // Apply price range filter
    products = products.filter(product => {
        const price = product.discount_price || product.price;
        return price >= priceRange.min && price <= priceRange.max;
    });
    
    // Apply spec filters
    if (Object.keys(currentFilters).length > 0) {
        products = products.filter(product => {
            for (const [specId, filterValue] of Object.entries(currentFilters)) {
                const filterElement = document.querySelector(`#filter-${specId}`);
                if (!filterElement || !filterElement.previousElementSibling) continue;
                
                const specName = filterElement.previousElementSibling.textContent;
                const productSpecValue = product.specs[specName];
                
                if (!productSpecValue || !productSpecValue.toLowerCase().includes(filterValue)) {
                    return false;
                }
            }
            return true;
        });
    }
    
    renderProducts(products);
    showNotification(`${products.length} produkte u gjeten`, 'success');
}

// ============================================
// PAGE NAVIGATION
// ============================================
function showPage(pageId, addToHistory = true) {
    // Hide all pages FIRST (prevents flash)
    document.querySelectorAll('.page-content').forEach(page => {
        page.style.display = 'none';
    });
    
    // Then scroll to top
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    window.scrollTo(0, 0);
    
    // Hide mobile filters by default
    const mobileFiltersContainer = document.getElementById('mobile-filters-container');
    if (mobileFiltersContainer) mobileFiltersContainer.style.display = 'none';
    
    // Show/hide sidebar (desktop only)
    const sidebar = document.getElementById('sidebar');
    if (['special-offers', 'brands', 'contact', 'checkout', 'wishlist', 'cart', 'brand-products', 'product-detail'].includes(pageId)) {
        sidebar.style.display = 'none';
    } else {
        // Only show sidebar on desktop for home page
        if (window.innerWidth >= 768 && pageId === 'home') {
            sidebar.style.display = 'block';
        } else {
            sidebar.style.display = 'none';
        }
    }
    
    previousPage = currentPage;
    currentPage = pageId;
    console.log('📄 Page changed:', previousPage, '→', currentPage);

    // Add to browser history
    if (addToHistory) {
        const url = pageId === 'home' ? '/' : `/#${pageId}`;
        window.history.pushState({ 
            page: pageId,
            timestamp: Date.now()
        }, '', url);
    }
    
    // Show selected page and load content
    switch(pageId) {
        case 'home':
            document.getElementById('home-page').style.display = 'block';
            // Show banner on home if it has an image
            const banner = document.getElementById('home-banner');
            const bannerImg = document.getElementById('banner-image');
            if (banner && bannerImg && bannerImg.src && bannerImg.src !== window.location.href) {
                banner.classList.remove('hidden');
            }
            // Only show desktop categories on desktop
            if (window.innerWidth >= 768) {
                showCategories();
            }
            break;
        case 'special-offers':
            document.getElementById('special-offers-page').style.display = 'block';
            loadSpecialOffers();
            break;
        case 'brands':
            document.getElementById('brands-page').style.display = 'block';
            loadBrandsPage();
            break;
        case 'contact':
            document.getElementById('contact-page').style.display = 'block';
            break;
        case 'checkout':
            if (cartItems.length === 0) {
                showNotification('Shporta eshte bosh', 'error');
                showPage('cart');
                return;
            }
            document.getElementById('checkout-page').style.display = 'block';
            loadCheckoutSummary();
            break;
        case 'cart':
            document.getElementById('cart-page').style.display = 'block';
            loadCartPage();
            break;
        case 'wishlist':
            document.getElementById('wishlist-page').style.display = 'block';
            loadWishlistPage();
            break;
    }
    // Force scroll to top again after a tick
    setTimeout(() => {
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
        window.scrollTo(0, 0);
    }, 0);
}

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    console.log('📍 Popstate triggered');
    console.log('   Current state:', event.state);
    console.log('   Current URL:', window.location.href);
    console.log('   Current hash:', window.location.hash);
    console.log('   History length:', window.history.length);
    
    // Prevent duplicate history entries
    window.isNavigatingHistory = true;
    
    // Scroll to top
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    window.scrollTo(0, 0);
    
    // Handle navigation based on state OR hash
    if (event.state && event.state.page) {
        handleNavigation(event.state);
    } else {
        // Fallback to hash
        const hash = window.location.hash.substring(1) || 'home';
        console.log('   No state, using hash:', hash);
        
        if (hash === 'home' || hash === '') {
            showPage('home', false);
            loadPopularProducts();
        } else if (hash.startsWith('product/')) {
            const productId = parseInt(hash.split('/')[1]);
            showProductDetail(productId);
        } else if (hash.startsWith('brand/')) {
            const brandName = decodeURIComponent(hash.split('/')[1]);
            showBrandProducts(brandName);
        } else if (hash.startsWith('subcategory/')) {
            const parts = hash.split('/');
            const subcategoryId = parseInt(parts[1]);
            const subcategoryName = decodeURIComponent(parts[2] || 'Products');
            loadSubcategoryProducts(subcategoryId, subcategoryName);
        } else {
            showPage(hash, false);
        }
    }
    
    // Clear flag after navigation completes
    setTimeout(() => {
        window.isNavigatingHistory = false;
        console.log('🏁 Navigation flag cleared');
    }, 500);
});

// Helper function to handle navigation
function handleNavigation(state) {
    console.log('🔄 Handling navigation to:', state.page);
    
    switch(state.page) {
        case 'product-detail':
            if (state.productId) {
                console.log('→ Loading product:', state.productId);
                showProductDetail(state.productId);
            }
            break;
        case 'brand-products':
            if (state.brandName) {
                console.log('→ Loading brand products:', state.brandName);
                showBrandProducts(state.brandName);
            }
            break;
        case 'subcategory':
            if (state.subcategoryId) {
                console.log('→ Loading subcategory:', state.subcategoryId);
                loadSubcategoryProducts(state.subcategoryId, state.subcategoryName || 'Products');
            }
            break;
        case 'home':
            console.log('→ Loading home');
            showPage('home', false);
            loadPopularProducts();
            break;
        default:
            console.log('→ Loading page:', state.page);
            showPage(state.page, false);
    }
}

function goBack() {
    window.history.back();
}

function showWishlist() {
    showPage('wishlist');
}

// ============================================
// SEARCH
// ============================================
async function performSearch() {
    const query = document.getElementById('search-input').value.trim();
    
    if (!query) {
        showNotification('Shkruani diçka për të kërkuar', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const products = await response.json();
        
        document.getElementById('products-title').textContent = `Search results for "${query}"`;
        renderProducts(products);
        
        showPage('home');
        
        if (products.length === 0) {
            showNotification('Nuk u gjete asnje produkt. Kerko me fjale te tjera kyc.', 'error');
        } else {
            showNotification(`U gjeten ${products.length} produkte te pershtatshme`, 'success');
        }
    } catch (error) {
        console.error('❌ Search failed:', error);
        showNotification('Kërkimi dështoi', 'error');
    }
}

function performSearchMobile() {
    const query = document.getElementById('search-input-mobile').value.trim();
    
    if (!query) {
        showNotification('Shkruani diçka për të kërkuar', 'error');
        return;
    }
    
    // Use the same search logic
    document.getElementById('search-input').value = query;
    performSearch();
}

// Sync mobile search with Enter key
document.addEventListener('DOMContentLoaded', () => {
    const searchInputMobile = document.getElementById('search-input-mobile');
    if (searchInputMobile) {
        searchInputMobile.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearchMobile();
            }
        });
    }
});

// Enter key support for search
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
});

// ============================================
// UTILITY FUNCTIONS
// ============================================
function formatPrice(price) {
    return `${Math.round(price)} ALL`;
}

function showNotification(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ============================================
// SEO HELPER FUNCTIONS
// ============================================
function updateMetaTag(name, content) {
    // Try property first (for og: tags)
    let meta = document.querySelector(`meta[property="${name}"]`);
    if (!meta) {
        // Try name attribute
        meta = document.querySelector(`meta[name="${name}"]`);
    }
    if (meta) {
        meta.setAttribute('content', content);
    }
}

function updatePageSEO(title, description) {
    document.title = title;
    updateMetaTag('description', description);
    updateMetaTag('og:title', title);
    updateMetaTag('og:description', description);
}

// ============================================
// SCROLL TO TOP BUTTON
// ============================================
(function() {
  function init() {
    const scrollBtn = document.getElementById('scroll-to-top-btn');
    const scrollContainer = document.body;

    if (!scrollBtn) {
      console.error('❌ Scroll button not found');
      return;
    }

    // Show/hide button when scrolling
    scrollContainer.addEventListener('scroll', () => {
      const scrollTop = scrollContainer.scrollTop;
      if (scrollTop > 300) {
        scrollBtn.classList.add('visible');
      } else {
        scrollBtn.classList.remove('visible');
      }
    }, { passive: true });

    // Scroll smoothly to top when button clicked
    scrollBtn.addEventListener('click', () => {
      scrollContainer.scrollTo({ top: 0, behavior: 'smooth' });
    });

    console.log('✅ Scroll button initialized and listening on <body>');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();


// ============================================
// INITIALIZE ON PAGE LOAD
// ============================================
document.addEventListener('DOMContentLoaded', initializeApp);

// Debug: Track all clicks on product detail page
document.addEventListener('click', function(e) {
    if (currentPage === 'product-detail') {
        console.log('🖱️ Click detected on product page:', e.target.tagName, e.target.className);
    }
}, true);

</script>
</body>
</html>