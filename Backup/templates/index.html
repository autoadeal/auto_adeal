<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Parts Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <!-- Fallback for Canva SDKs when running locally -->
<script>
  // If the real Canva SDKs aren't present, provide simple local implementations
  // that match the minimal methods your app calls: init, create, update, delete.
  (function () {
    // Helper: load stored items from localStorage
    function loadStored() {
      try {
        return JSON.parse(localStorage.getItem('canva_data') || '[]');
      } catch (e) {
        return [];
      }
    }
    function saveStored(arr) {
      localStorage.setItem('canva_data', JSON.stringify(arr));
    }

    // Minimal dataSdk stub
    if (!window.dataSdk) {
      window.dataSdk = {
        async init(handler) {
          // store handler so we can notify on changes
          this._handler = handler || null;
          // ensure storage exists
          if (!localStorage.getItem('canva_data')) saveStored([]);
          // Immediately call onDataChanged with existing data (if handler provided)
          if (this._handler && typeof this._handler.onDataChanged === 'function') {
            try { this._handler.onDataChanged(loadStored()); } catch (e) { console.error(e); }
          }
          return { isOk: true };
        },
        // create: adds an item and notifies
        async create(item) {
          const stored = loadStored();
          // add an id if not present
          const id = item.__localId || ('local_' + Date.now() + '_' + Math.floor(Math.random()*10000));
          const toStore = Object.assign({ __localId: id }, item);
          stored.push(toStore);
          saveStored(stored);
          if (this._handler && typeof this._handler.onDataChanged === 'function') {
            try { this._handler.onDataChanged(stored); } catch (e) { console.error(e); }
          }
          return { isOk: true, data: toStore };
        },
        // delete: accepts either an object from stored data or an object with productId/type
        async delete(target) {
          const stored = loadStored();
          let removed = false;
          // if target has __localId, remove by that
          if (target && target.__localId) {
            const idx = stored.findIndex(x => x.__localId === target.__localId);
            if (idx !== -1) { stored.splice(idx,1); removed = true; }
          } else if (target && target.productId) {
            // remove first matching by type and productId
            const idx = stored.findIndex(x => x.type === target.type && x.productId === target.productId);
            if (idx !== -1) { stored.splice(idx,1); removed = true; }
          }
          if (removed) {
            saveStored(stored);
            if (this._handler && typeof this._handler.onDataChanged === 'function') {
              try { this._handler.onDataChanged(stored); } catch (e) { console.error(e); }
            }
            return { isOk: true };
          }
          return { isOk: false, error: 'not_found' };
        },
        // update: merges fields for the item
        async update(target) {
          const stored = loadStored();
          if (!target) return { isOk: false, error: 'no_target' };
          // find by __localId or by productId + type
          let idx = -1;
          if (target.__localId) idx = stored.findIndex(x => x.__localId === target.__localId);
          if (idx === -1 && target.productId) idx = stored.findIndex(x => x.productId === target.productId && x.type === target.type);
          if (idx !== -1) {
            stored[idx] = Object.assign({}, stored[idx], target);
            saveStored(stored);
            if (this._handler && typeof this._handler.onDataChanged === 'function') {
              try { this._handler.onDataChanged(stored); } catch (e) { console.error(e); }
            }
            return { isOk: true, data: stored[idx] };
          }
          return { isOk: false, error: 'not_found' };
        },
        // convenience: list all
        async list() {
          return { isOk: true, data: loadStored() };
        }
      };
      console.info('Using local dataSdk fallback (localStorage).');
    }

    // Minimal elementSdk stub
    if (!window.elementSdk) {
      window.elementSdk = {
        async init(cfg) {
          // If config has a render function, call it with defaultConfig to populate UI
          try {
            if (cfg && typeof cfg.render === 'function') {
              // pass cfg.defaultConfig (like Canva would)
              await cfg.render(cfg.defaultConfig || {});
            }
          } catch (e) {
            console.error('elementSdk fallback render error', e);
          }
          // Return an object similar to the real SDK
          return { isOk: true };
        }
      };
      console.info('Using local elementSdk fallback.');
    }
  })();
</script>
  <style>
        body {
            box-sizing: border-box;
        }
        .scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
            transition: all 0.3s ease;
        }
        .scroll-to-top:hover {
            background: #b91c1c;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.5);
        }

        .category-item:hover {
            background-color: #f3f4f6;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .product-card {
            transition: all 0.3s ease;
        }
        .price-slider {
            position: relative;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin: 20px 0;
        }
        .price-slider-track {
            position: absolute;
            height: 6px;
            background: #8c1d1d;
            border-radius: 3px;
        }
        .price-slider-thumb {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #8c1d1d;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            top: -7px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .price-slider-thumb:hover {
            background: #6b1515;
        }
        .price-values {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #6b7280;

        }
        #account-dropdown {
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-white"><!-- Header -->
  <header class="bg-black text-white py-7">
   <div class="container mx-auto px-6">
    <div class="flex items-center justify-between"><!-- Logo -->
     <div class="flex items-center"><button onclick="showPage('home'); loadPopularProducts();" class="text-2xl font-bold text-white hover:text-gray-300 transition-colors"><span id="logo-text">AutoParts Pro</span></button>
     </div><!-- Search Bar -->
     <div class="flex-1 max-w-md mx-8">
      <div class="flex"><input type="text" id="search-input" placeholder="Search..." class="flex-1 px-4 py-2 rounded-l-full text-black focus:outline-none"> <button
  onclick="performSearch()"
  class="relative bg-red-600 hover:bg-red-700 pl-6 pr-7 py-2 rounded-r-full transition-colors flex items-center"
>
  <svg xmlns="http://www.w3.org/2000/svg"
       class="w-5 h-5 text-white"
       fill="none"
       viewBox="0 0 24 24"
       stroke="currentColor"
       stroke-width="3"
       style="transform: translateX(-3px);">
    <path stroke-linecap="round" stroke-linejoin="round"
          d="M21 21l-4.35-4.35m1.6-5.65a7 7 0 11-14 0 7 7 0 0114 0z" />
  </svg>
</button>
      </div>
     </div><!-- Right Side Controls -->
     <div class="flex items-center space-x-6">
      <!-- Account Dropdown -->
      <div class="relative">
        <!-- Account Button (always visible) -->
        <button id="account-button" onclick="toggleAccountDropdown()" class="flex items-center space-x-2 text-white hover:text-red-500 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
          <span id="account-label">Account</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        
        <!-- Dropdown Menu -->
        <div id="account-dropdown" class="hidden absolute right-0 mt-2 w-34 bg-white rounded-lg shadow-lg py-2 z-50">
          <!-- Logged Out Options -->
          <div id="logged-out-options">
            <button onclick="showLoginModal(); closeAccountDropdown();" class="w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">
              Login
            </button>
            <button onclick="showSignupModal(); closeAccountDropdown();" class="w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-100 transition-colors">
              Sign Up
            </button>
          </div>
          
          <!-- Logged In Options -->
          <div id="logged-in-options" class="hidden">
            <div class="px-4 py-2 border-b border-gray-200">
              <p id="dropdown-user-name" class="font-semibold text-black text-sm"></p>
              <p id="dropdown-user-email" class="text-xs text-gray-600 truncate"></p>
            </div>
            <button onclick="logout(); closeAccountDropdown();" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 transition-colors">
              Logout
            </button>
          </div>
        </div>
      </div>
  <!-- Wishlist -->
  <button onclick="showWishlist()" class="relative hover:text-red-500 transition-colors flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg"
         class="w-6 h-6 text-white"
         fill="none"
         viewBox="0 0 24 24"
         stroke="currentColor"
         stroke-width="2.5">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
    </svg>
    <span id="wishlist-count"
          class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">0</span>
  </button>

  <!-- Cart -->
  <button onclick="showPage('cart')" class="relative hover:text-red-500 transition-colors flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg"
         class="w-6 h-6 text-white"
         fill="none"
         viewBox="0 0 24 24"
         stroke="currentColor"
         stroke-width="2.5">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.2 6h12.8M10 19a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z"/>
    </svg>
    <span id="cart-count"
          class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">0</span>
  </button>
      </div>
     </div>
    </div>
   </div>
  </header><!-- Navigation Bar -->
  <nav class="bg-white border-b border-gray-200 py-4">
   <div class="container mx-auto px-6">
    <div class="flex justify-center space-x-24"><button onclick="showPage('home'); loadPopularProducts();"class="text-black hover:text-red-600 font-medium transition-colors">Home</button> <button onclick="showPage('special-offers')" class="text-black hover:text-red-600 font-medium transition-colors">Special Offers</button> <button onclick="showPage('brands')" class="text-black hover:text-red-600 font-medium transition-colors">Brands</button> <button onclick="showPage('contact')" class="text-black hover:text-red-600 font-medium transition-colors">Contact Us</button>
    </div>
   </div>
  </nav><!-- Main Content -->
  <div class="flex min-h-screen"><!-- Sidebar -->
   <aside id="sidebar" class="w-64 bg-gray-50 p-6">
    <div id="categories-section">
        <h3 class="font-bold text-lg mb-4 text-black">Categories</h3>
        <!-- ‚úÖ This container will be filled dynamically -->
        <div id="categories-container" class="space-y-3"></div>
    </div>

    <div id="filters-section" style="display: none;">
     <div class="flex items-center justify-between mb-4">
      <h3 class="font-bold text-lg text-black">Filters</h3><button onclick="showCategories()" class="text-red-600 hover:text-red-700 text-sm">‚Üê Categories</button>
     </div>
     <div id="dynamic-filters" class="space-y-4"><!-- Dynamic filters will be populated here -->
     </div><button onclick="applyFilters()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors mt-4"> Apply Filters </button>
    </div>
   </aside><!-- Main Content Area -->
   <main class="flex-1 p-6"><!-- Home Page -->
    <div id="home-page" class="page-content">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-black mb-4">Welcome to AutoParts Pro</h1>
      <p class="text-gray-600 text-lg">Find quality auto parts for all major car brands</p>
     </div>
     <!-- ‚úÖ Products Section -->
    <div id="products-section" class="w-full p-6">
    <h3 id="products-title" class="text-2xl font-bold mb-4 text-black">T√´ fundit</h3>
    <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <!-- Products will appear here -->
    </div>
    </div>
     <!-- üß† Dynamic product listing area -->
        <div id="products-section" class="bg-white p-4 rounded-xl shadow-sm w-full">
        <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
           <!-- Products will be dynamically loaded here -->
        </div>
        </div>
    </div><!-- Special Offers Page -->
    <div id="special-offers-page" class="page-content" style="display: none;">
     <h1 class="text-3xl font-bold text-black mb-6">Special Offers</h1>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="offers-grid"><!-- Special offers will be loaded here -->
     </div>
    </div><!-- Brands Page -->
    <div id="brands-page" class="page-content" style="display: none;">
     <h1 class="text-3xl font-bold text-black mb-6">Car Brands</h1>
     <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6" id="brands-grid">
      <!-- Brands will be loaded here -->
     </div>
    </div>
    
    <!-- Brand Products Page -->
    <div id="brand-products-page" class="page-content" style="display: none;">
     <div class="flex items-center justify-between mb-6">
      <h1 id="brand-title" class="text-3xl font-bold text-black"></h1><button onclick="showPage('brands')" class="text-red-600 hover:text-red-700">‚Üê Back to Brands</button>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="brand-products-grid"><!-- Brand products will be loaded here -->
     </div>
    </div>
    
    <div id="contact-page" class="page-content" style="display: none;"> 
        <h1 class="text-3xl font-bold text-black mb-8 text-center">Na Kontaktoni</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12 max-w-5xl mx-auto">
            <!-- Contact Information -->
            <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg text-black mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              Ku Mund te na Kontaktoni
            </h3>
            <div class="space-y-3 text-gray-700">
              <p><strong>Email:</strong> <span id="contact-email-display">autoadeal@gmail.com</span></p>
              <p><strong>Whatsapp:</strong> <span id="contact-phone-display">+355 68 552 6714</span></p>
              <p><strong>Vendndodhja:</strong> <span id="contact-location-display">Sarande, Shqiperi</span></p>
              <p><strong>Instagram:</strong> 
                <a href="https://www.instagram.com/autoadeal" target="_blank" class="text-red-600 hover:text-red-700">@autoadeal</a>
              </p>
            </div>
            </div>
            <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg text-black mb-4 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
              </svg>
              Politika e Dergesave
            </h3>
            <ul class="space-y-3 text-gray-700">
              <li><strong>Shqiperi:</strong> Kushton 300 ALL dhe vonon 2‚Äì4 dite</li>
              <li><strong>Kosove:</strong> Kushton 700 ALL dhe vonon 4‚Äì5 dite</li>
            </ul>
            <p class="text-gray-600 mt-4 text-sm">
              Porosite procesohen cdo dite. Koha e dergeses varjon nga vendndodhja juaj specifike. Na kontaktoni ne Instagram ose Whatsapp per cdo problem ne lidhje me porosine tuaj.
            </p>
            </div>
        </div> 

        <!-- Extra Section to Fill Page -->
        <div class="mt-16 text-center max-w-4xl mx-auto">
          <h3 class="text-2xl font-bold text-black mb-4 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            Keni Nevoje per Ndihme per te Vendosur?
          </h3>
          <p class="text-gray-700 text-lg mb-6">
            Ekipi yne eshte gjithmone gati t'ju ndihmoje te zgjidhni aksesoret ose pjeset e duhura per automjetin tuaj. 
            Na kontaktoni ne <span class="text-red-600 font-semibold">Instagram</span> ose Whatsapp per ndihme te shpejte.
          </p>
          
          <div class="flex justify-center space-x-4 mt-6">
            <a href="https://www.instagram.com/autoadeal" target="_blank"
              class="bg-red-600 text-white px-8 py-3 rounded-full hover:bg-red-700 transition-colors font-medium flex items-center space-x-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
              </svg>
              <span>Instagram</span>
            </a>
            
            <a href="https://wa.me/355685526714" target="_blank" 
              class="bg-green-500 text-white px-8 py-3 rounded-full hover:bg-green-600 transition-colors font-medium flex items-center space-x-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
              </svg>
              <span>Whatsapp</span>
            </a>
          </div>
        </div>
    </div>
                    

    <!-- Product Detail Page -->
    <div id="product-detail-page" class="page-content" style="display: none;"><button onclick="goBack()" class="text-red-600 hover:text-red-700 mb-4">‚Üê Back</button>
     <div id="product-detail-content"><!-- Product details will be loaded here -->
     </div>
    </div>
    
    <!-- Checkout Page -->
    <div id="checkout-page" class="page-content" style="display: none;">
     <h1 class="text-3xl font-bold text-black mb-6">Checkout</h1>
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div>
       <h3 class="font-bold text-lg text-black mb-4">Shipping Information</h3>
       <form id="checkout-form" onsubmit="processOrder(event)" class="space-y-4"><input type="text" id="checkout-name" placeholder="Full Name" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <input type="tel" id="checkout-phone" placeholder="Phone Number" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <select id="checkout-country" onchange="updateShipping()" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <option value="">Select Country</option> <option value="Albania">Albania</option> <option value="Kosovo">Kosovo</option> </select> <input type="text" id="checkout-city" placeholder="City" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <button type="submit" class="w-full bg-red-600 text-white py-3 rounded hover:bg-red-700 transition-colors">Place Order (Cash on Delivery)</button>
       </form>
      </div>
      <div>
       <h3 class="font-bold text-lg text-black mb-4">Order Summary</h3>
       <div id="checkout-summary" class="bg-gray-50 p-4 rounded"><!-- Order summary will be loaded here -->
       </div>
      </div>
     </div>
    </div>
    
    <!-- Cart Page -->
    <div id="cart-page" class="page-content" style="display: none;">
     <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-black">Shopping Cart</h1><button onclick="showPage('home')" class="text-red-600 hover:text-red-700">‚Üê Continue Shopping</button>
     </div>
     <div id="cart-content"><!-- Cart content will be loaded here -->
     </div>
    </div>
    
    <!-- Wishlist Page -->
    <div id="wishlist-page" class="page-content" style="display: none;">
     <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-black">My Wishlist</h1><button onclick="showPage('home')" class="text-red-600 hover:text-red-700">‚Üê Continue Shopping</button>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="wishlist-grid"><!-- Wishlist items will be loaded here -->
     </div>
    </div>
   </main>
  </div>
  
  <!-- Login/Signup Modal -->
  <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
   <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
    <div class="flex justify-between items-center mb-6">
     <h2 id="auth-title" class="text-2xl font-bold text-black">Login</h2><button onclick="closeAuthModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
    </div><!-- Login Form -->
    <form id="login-form" onsubmit="handleLogin(event)">
     <div class="space-y-4"><input type="email" id="login-email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <button type="submit" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors">Login</button>
     </div>
     <div class="mt-4 text-center"><button type="button" onclick="showForgotPassword()" class="text-red-600 hover:text-red-700 text-sm">Forgot Password?</button>
     </div>
     <div class="mt-4 text-center"><button type="button" onclick="showSignupForm()" class="text-gray-600 hover:text-gray-800">Don't have an account? Sign up</button>
     </div>
    </form><!-- Signup Form -->
    <form id="signup-form" onsubmit="handleSignup(event)" style="display: none;">
     <div class="space-y-4"><input type="text" id="signup-name" placeholder="Name" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <input type="text" id="signup-surname" placeholder="Surname" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <input type="email" id="signup-email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <input type="password" id="signup-password" placeholder="Password" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <button type="submit" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors">Sign Up</button>
     </div>
     <div class="mt-4 text-center"><button type="button" onclick="showLoginForm()" class="text-gray-600 hover:text-gray-800">Already have an account? Login</button>
     </div>
    </form><!-- Forgot Password Form -->
    <form id="forgot-form" onsubmit="handleForgotPassword(event)" style="display: none;">
     <div class="space-y-4">
      <p class="text-gray-600 text-sm">Enter your email to receive password recovery instructions.</p><input type="email" id="forgot-email" placeholder="Email" required class="w-full px-4 py-2 border border-gray-300 rounded text-black"> <button type="submit" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors">Send Recovery Email</button>
     </div>
     <div class="mt-4 text-center"><button type="button" onclick="showLoginForm()" class="text-gray-600 hover:text-gray-800">‚Üê Back to Login</button>
     </div>
    </form>
   </div>
  </div><!-- Scroll to Top Button --> <button class="scroll-to-top" onclick="scrollToTop()">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
    <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"/>
  </svg>
</button>
  <script>
// ============================================
// GLOBAL STATE & CONFIGURATION
// ============================================

let currentPage = 'home';
let previousPage = 'home';
let cartItems = [];
let wishlistItems = [];
let categoriesData = [];

const EUR_TO_ALL = 94.34; // Keep this

// ============================================
// AUTHENTICATION
// ============================================
function loadUserFromStorage() {
    const stored = localStorage.getItem('auto_adeal_user');
    const loginTime = localStorage.getItem('auto_adeal_login_time');
    
    if (stored && loginTime) {
        const daysSinceLogin = (Date.now() - parseInt(loginTime)) / (1000 * 60 * 60 * 24);
        
        if (daysSinceLogin < 730) { // 730 days = 2 years
            try {
                currentUser = JSON.parse(stored);
                updateAuthUI();
            } catch (e) {
                localStorage.removeItem('auto_adeal_user');
                localStorage.removeItem('auto_adeal_login_time');
            }
        } else {
            // Login expired
            localStorage.removeItem('auto_adeal_user');
            localStorage.removeItem('auto_adeal_login_time');
        }
    }
}

function saveUserToStorage(user) {
    localStorage.setItem('auto_adeal_user', JSON.stringify(user));
    localStorage.setItem('auto_adeal_login_time', Date.now().toString());
}

function updateAuthUI() {
    const accountLabel = document.getElementById('account-label');
    const loggedOutOptions = document.getElementById('logged-out-options');
    const loggedInOptions = document.getElementById('logged-in-options');
    const dropdownUserName = document.getElementById('dropdown-user-name');
    const dropdownUserEmail = document.getElementById('dropdown-user-email');
    
    if (currentUser) {
        accountLabel.textContent = currentUser.name;
        loggedOutOptions.classList.add('hidden');
        loggedInOptions.classList.remove('hidden');
        dropdownUserName.textContent = `${currentUser.name} ${currentUser.surname}`;
        dropdownUserEmail.textContent = currentUser.email;
    } else {
        accountLabel.textContent = 'Account';
        loggedOutOptions.classList.remove('hidden');
        loggedInOptions.classList.add('hidden');
    }
}

function showLoginModal() {
    document.getElementById('auth-modal').style.display = 'flex';
    document.getElementById('auth-title').textContent = 'Login';
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('signup-form').style.display = 'none';
    document.getElementById('forgot-form').style.display = 'none';
}

function showSignupModal() {
    document.getElementById('auth-modal').style.display = 'flex';
    document.getElementById('auth-title').textContent = 'Sign Up';
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('signup-form').style.display = 'block';
    document.getElementById('forgot-form').style.display = 'none';
}

function closeAuthModal() {
    document.getElementById('auth-modal').style.display = 'none';
    // Reset forms
    document.getElementById('login-form').reset();
    document.getElementById('signup-form').reset();
    document.getElementById('forgot-form').reset();
}

function showLoginForm() {
    showLoginModal();
}

function showSignupForm() {
    showSignupModal();
}

function showForgotPassword() {
    document.getElementById('auth-title').textContent = 'Reset Password';
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('signup-form').style.display = 'none';
    document.getElementById('forgot-form').style.display = 'block';
}

async function handleLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentUser = data.user;
            saveUserToStorage(data.user);
            updateAuthUI();
            closeAuthModal();
            showNotification('Login successful!', 'success');
        } else {
            showNotification(data.error || 'Login failed', 'error');
        }
    } catch (error) {
        console.error('Login error:', error);
        showNotification('Login failed', 'error');
    }
}

async function handleSignup(event) {
    event.preventDefault();
    
    const name = document.getElementById('signup-name').value;
    const surname = document.getElementById('signup-surname').value;
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    
    try {
        const response = await fetch('/api/auth/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, surname, email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentUser = data.user;
            saveUserToStorage(data.user);
            updateAuthUI();
            closeAuthModal();
            showNotification('Account created successfully!', 'success');
        } else {
            showNotification(data.error || 'Signup failed', 'error');
        }
    } catch (error) {
        console.error('Signup error:', error);
        showNotification('Signup failed', 'error');
    }
}

async function handleForgotPassword(event) {
    event.preventDefault();
    
    const email = document.getElementById('forgot-email').value;
    
    try {
        const response = await fetch('/api/auth/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('Password reset link sent to your email', 'success');
            closeAuthModal();
        } else {
            showNotification(data.error || 'Request failed', 'error');
        }
    } catch (error) {
        console.error('Forgot password error:', error);
        showNotification('Request failed', 'error');
    }
}

function logout() {
    currentUser = null;
    localStorage.removeItem('auto_adeal_user');
    localStorage.removeItem('auto_adeal_login_time');
    updateAuthUI();
    showNotification('Logged out successfully', 'success');
}

function toggleAccountDropdown() {
    const dropdown = document.getElementById('account-dropdown');
    dropdown.classList.toggle('hidden');
}

function closeAccountDropdown() {
    document.getElementById('account-dropdown').classList.add('hidden');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const accountButton = document.getElementById('account-button');
    const dropdown = document.getElementById('account-dropdown');
    
    if (accountButton && dropdown && !accountButton.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.add('hidden');
    }
});

// ============================================
// INITIALIZATION
// ============================================
async function initializeApp() {
    console.log('üöÄ Initializing app...');
    
    // Load user session
    loadUserFromStorage();
    
    // Load categories
    await loadCategories();
    
    // Check URL and load appropriate page
    const hash = window.location.hash.substring(1);
    if (hash.startsWith('product/')) {
        const productId = hash.split('/')[1];
        await showProductDetail(parseInt(productId));
    } else if (hash.startsWith('brand/')) {
        const brandName = decodeURIComponent(hash.split('/')[1]);
        await showBrandProducts(brandName);
    } else if (hash) {
        showPage(hash, false);
    } else {
        // Load popular products on home page
        await loadPopularProducts();
    }
    
    // Initialize cart and wishlist from localStorage
    loadCartFromStorage();
    loadWishlistFromStorage();
    
    // Update UI
    updateCartCount();
    updateWishlistCount();
    
    // Setup scroll button
    setupScrollToTop();
    
    console.log('‚úÖ App initialized');
}

// ============================================
// CATEGORIES & NAVIGATION
// ============================================
async function loadCategories() {
    try {
        const response = await fetch('/api/categories');
        categoriesData = await response.json();
        renderCategories();
    } catch (error) {
        console.error('‚ùå Failed to load categories:', error);
        showNotification('Failed to load categories', 'error');
    }
}

function renderCategories() {
    const container = document.getElementById('categories-container');
    container.innerHTML = '';

    for (const category of categoriesData) {
        const catDiv = document.createElement('div');
        catDiv.classList.add('mb-4');

        // Category title
        const catTitle = document.createElement('h4');
        catTitle.classList.add('font-semibold', 'text-black', 'mb-2', 'cursor-pointer', 
                               'hover:text-red-600', 'transition-colors');
        catTitle.textContent = category.name;
        catTitle.onclick = () => toggleSubcategories(category.id);
        catDiv.appendChild(catTitle);

        // Subcategory list
        const subList = document.createElement('div');
        subList.classList.add('space-y-1', 'ml-3', 'hidden');
        subList.id = `subcats-${category.id}`;
        
        // Add subcategories first
        for (const sub of category.subcategories) {
            const btn = document.createElement('button');
            btn.textContent = sub.name;
            btn.classList.add('w-full', 'text-left', 'px-3', 'py-2', 'rounded', 
                             'text-black', 'hover:bg-gray-200', 'transition-colors', 'text-sm');
            btn.onclick = () => loadSubcategoryProducts(sub.id, sub.name);
            subList.appendChild(btn);
        }
        
        // Add "Te gjitha" button at the bottom
        const allBtn = document.createElement('button');
        allBtn.textContent = 'Te gjitha';
        allBtn.classList.add('w-full', 'text-left', 'px-3', 'py-2', 'rounded', 
                             'text-black', 'hover:bg-gray-200', 'transition-colors', 'text-sm');
        allBtn.onclick = () => loadCategoryProducts(category.id, category.name);
        subList.appendChild(allBtn);

        catDiv.appendChild(subList);
        container.appendChild(catDiv);
    }
}

function toggleSubcategories(categoryId) {
    const subDiv = document.getElementById(`subcats-${categoryId}`);
    if (subDiv) {
        subDiv.classList.toggle('hidden');
    }
}

// Load all products from a category
async function loadCategoryProducts(categoryId, categoryName) {
    try {
        // Find all subcategories in this category
        const category = categoriesData.find(cat => cat.id === categoryId);
        if (!category) return;
        
        let allProducts = [];
        
        // Fetch products from each subcategory
        for (const sub of category.subcategories) {
            const response = await fetch(`/api/subcategory/${sub.id}/products`);
            const products = await response.json();
            allProducts = allProducts.concat(products);
        }
        
        document.getElementById('products-title').textContent = categoryName;
        renderProducts(allProducts);
        
        // Show price range filter only
        showPriceOnlyFilters();
    } catch (error) {
        console.error('‚ùå Failed to load category products:', error);
        showNotification('Failed to load products', 'error');
    }
}

// Show only price filter (for categories and brands)
function showPriceOnlyFilters() {
    currentSubcategoryId = null;
    priceRange = { min: 0, max: 20000 };
    
    document.getElementById('categories-section').style.display = 'none';
    document.getElementById('filters-section').style.display = 'block';
    
    const filtersContainer = document.getElementById('dynamic-filters');
    filtersContainer.innerHTML = '';
    filtersContainer.appendChild(createPriceRangeFilter());
    initializePriceSlider();
}

// ============================================
// PRODUCT LOADING
// ============================================
async function loadSubcategoryProducts(subcategoryId, subcategoryName) {
    try {
        const response = await fetch(`/api/subcategory/${subcategoryId}/products`);
        const products = await response.json();
        
        document.getElementById('products-title').textContent = subcategoryName;
        renderProducts(products);
        
        // Load filters for this subcategory
        await loadSubcategoryFilters(subcategoryId);
    } catch (error) {
        console.error('‚ùå Failed to load products:', error);
        showNotification('Failed to load products', 'error');
    }
}

async function loadPopularProducts() {
    try {
        const response = await fetch('/api/products/popular');
        const products = await response.json();
        
        document.getElementById('products-title').textContent = 'T√´ fundit';
        renderProducts(products);
    } catch (error) {
        console.error('‚ùå Failed to load popular products:', error);
    }
}

function loadBrandsPage() {
    const brands = [
        'Volkswagen', 'BMW', 'Audi', 'Mercedes-Benz', 'Toyota', 'Ford', 
        'Skoda', 'Porsche', 'SEAT', 'Opel', 'Fiat', 'Range Rover', 
        'Tesla', 'Hyundai', 'Citro√´n', 'MINI', 'Honda', 'Peugeot', 
        'Renault', 'Nissan', 'Volvo', 'Mazda'
    ];
    
    const grid = document.getElementById('brands-grid');
    grid.innerHTML = '';
    
    brands.forEach(brand => {
        const brandSlug = brand.toLowerCase().replace(/\s+/g, '-').replace(/√´/g, 'e');
        const card = document.createElement('div');
        card.onclick = () => showBrandProducts(brand);
        card.className = 'bg-white border border-gray-200 rounded-lg p-4 text-center cursor-pointer hover:shadow-lg transition-shadow';
        
        card.innerHTML = `
            <div class="aspect-square mb-3 flex items-center justify-center bg-white rounded-lg overflow-hidden">
                <img src="/static/brands/${brandSlug}.png" 
                     alt="${brand}" 
                     class="w-full h-full object-contain p-2"
                     onerror="this.src='/static/brands/default.png'">
            </div>
            <h3 class="font-bold text-black text-sm">${brand}</h3>
        `;
        
        grid.appendChild(card);
    });
}

async function showBrandProducts(brandName) {
    try {
        const response = await fetch(`/api/brands/${encodeURIComponent(brandName)}/products`);
        const products = await response.json();
        
        // Show brand products page
        document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
        document.getElementById('brand-products-page').style.display = 'block';
        document.getElementById('sidebar').style.display = 'none';
        
        document.getElementById('brand-title').textContent = `${brandName} Products`;
        
        const grid = document.getElementById('brand-products-grid');
        grid.innerHTML = '';
        
        if (products.length === 0) {
            grid.innerHTML = '<p class="col-span-full text-center text-gray-500">No products found for this brand.</p>';
            return;
        }
        
        products.forEach(product => {
            grid.appendChild(createProductCard(product));
        });
        
        previousPage = currentPage;
        currentPage = 'brand-products';
        window.history.pushState({ page: 'brand-products', brand: brandName }, '', `/#brand/${brandName}`);
    } catch (error) {
        console.error('‚ùå Failed to load brand products:', error);
        showNotification('Failed to load brand products', 'error');
    }
}

async function loadSpecialOffers() {
    const container = document.getElementById('offers-grid');
    container.innerHTML = '<p class="text-gray-500">Loading offers...</p>';
    
    try {
        const response = await fetch('/api/products/specials');
        const products = await response.json();
        
        if (!products || products.length === 0) {
            container.innerHTML = '<p class="text-gray-500 col-span-full text-center">Nuk ka oferta aktualisht.</p>';
            return;
        }
        
        container.innerHTML = '';
        products.forEach(product => {
            container.appendChild(createProductCard(product));
        });
    } catch (error) {
        console.error('‚ùå Failed to load special offers:', error);
        container.innerHTML = '<p class="text-gray-500">Gabim gjat√´ ngarkimit t√´ ofertave.</p>';
    }
}

function renderProducts(products) {
    const container = document.getElementById('products-container');
    container.innerHTML = '';
    
    if (products.length === 0) {
        container.innerHTML = '<p class="text-gray-500 col-span-full text-center">No products found.</p>';
        return;
    }
    
    products.forEach(product => {
        container.appendChild(createProductCard(product));
    });
}

function createProductCard(product) {
    const card = document.createElement('div');
    card.classList.add('bg-white', 'border', 'border-gray-200', 'rounded-xl', 
                       'p-4', 'shadow-sm', 'hover:shadow-md', 'transition-shadow', 
                       'cursor-pointer', 'product-card');
    
    // Extract values to avoid editor warnings
    const productId = product.id;
    const productName = product.name.replace(/'/g, "\\'"); // Escape quotes
    const productPrice = product.price;
    const productDiscountPrice = product.discount_price || product.price;
    const imageURL = product.main_image || '/static/uploads/default.png';
    
    const isInWishlist = wishlistItems.some(item => item.productId === productId);
    const isInCart = cartItems.some(item => item.productId === productId);
    
    // Price display - side by side if discount
    let priceHTML = '';
    if (product.discount_price && product.discount_price < product.price) {
        priceHTML = `
            <div class="flex items-center space-x-2">
                <p class="text-red-700 font-bold text-lg">${formatPrice(productDiscountPrice)}</p>
                <p class="text-sm text-gray-500 line-through">${formatPrice(productPrice)}</p>
            </div>
        `;
    } else {
        priceHTML = `<p class="text-red-700 font-bold text-lg">${formatPrice(productPrice)}</p>`;
    }
    
    card.innerHTML = `
        <div onclick="showProductDetail(${productId})" class="cursor-pointer">
            <div class="aspect-square mb-3 flex items-center justify-center bg-white rounded-lg overflow-hidden">
                <img src="${imageURL}" alt="${productName}" class="w-full h-full object-contain">
            </div>
            <h4 class="font-semibold text-black mb-2 text-center min-h-[48px]">${productName}</h4>
            ${priceHTML}
        </div>
        
        <div class="flex space-x-2 mt-4">
            <button
                onclick="event.stopPropagation(); toggleWishlist(${productId}, '${productName}', ${productPrice}, '${imageURL}')"
                class="flex-1 ${isInWishlist ? 'bg-red-600 text-white' : 'bg-gray-200 text-black'} py-2 rounded hover:bg-red-700 hover:text-white transition-colors flex items-center justify-center"
                title="${isInWishlist ? 'Remove from wishlist' : 'Add to wishlist'}"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="${isInWishlist ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
            </button>
            
            <button
                onclick="event.stopPropagation(); addToCart(${productId}, '${productName}', ${productDiscountPrice}, '${imageURL}')"
                class="flex-1 ${isInCart ? 'bg-green-600' : 'bg-red-600'} text-white py-2 rounded hover:bg-red-700 transition-colors flex items-center justify-center"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 ${isInCart ? 'hidden' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.2 6h12.8M10 19a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z"/>
                </svg>
                <span class="${isInCart ? '' : 'ml-1'}">${isInCart ? '‚úì Added' : 'Cart'}</span>
            </button>
        </div>
    `;
    
    return card;
}

// ============================================
// PRODUCT DETAIL
// ============================================
async function showProductDetail(productId) {
    try {
        const response = await fetch(`/api/product/${productId}`);
        const product = await response.json();
        
        // Hide all pages
        document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
        document.getElementById('product-detail-page').style.display = 'block';
        document.getElementById('sidebar').style.display = 'none';
        
        const container = document.getElementById('product-detail-content');
        
        const mainImageURL = product.main_image || '/static/uploads/default.png';
        const priceDisplay = product.discount_price && product.discount_price < product.price
            ? `<div class="flex items-center space-x-3">
                 <p class="text-red-700 font-bold text-3xl">${formatPrice(product.discount_price)}</p>
                 <p class="text-gray-500 line-through text-xl">${formatPrice(product.price)}</p>
               </div>`
            : `<p class="text-red-700 font-bold text-3xl">${formatPrice(product.price)}</p>`;
        
        // Build specs HTML
        let specsHTML = '';
        if (product.specs && Object.keys(product.specs).length > 0) {
            specsHTML = '<div class="mb-6"><h3 class="font-bold text-lg mb-3 text-black">Specifikimet</h3><div class="grid grid-cols-2 gap-3">';
            for (const [key, value] of Object.entries(product.specs)) {
                specsHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-600 mb-1">${key}</p>
                        <p class="text-sm font-semibold text-black">${value}</p>
                    </div>
                `;
            }
            specsHTML += '</div></div>';
        }
        
        // Additional images
        let additionalImagesHTML = '';
        if (product.images && product.images.length > 0) {
            additionalImagesHTML = `
                <div class="grid grid-cols-4 gap-3 mt-4">
                    ${product.images.slice(0, 4).map(img => `
                        <div class="aspect-square border-2 border-gray-200 rounded-lg overflow-hidden cursor-pointer hover:border-red-600 transition-colors" 
                             onclick="document.querySelector('#main-product-image').src='${img}'">
                            <img src="${img}" class="w-full h-full object-contain">
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-12">
                <!-- Left side: Images centered -->
                <div class="flex items-center justify-center">
                    <div class="flex flex-col lg:flex-row items-center lg:items-start gap-4 max-w-[600px]">
                        <!-- Thumbnails -->
                        ${product.images && product.images.length > 0 ? `
                            <div class="flex lg:flex-col gap-3 w-full lg:w-auto px-2 lg:px-0">
                                ${product.images.slice(0, 4).map(img => `
                                    <div class="flex-shrink-0 aspect-square w-20 h-20 lg:w-[112px] lg:h-[112px] border-2 border-gray-200 rounded-lg overflow-hidden cursor-pointer hover:border-red-600 transition-colors bg-white"
                                        onclick="document.querySelector('#main-product-image').src='${img}'">
                                        <img src="${img}" class="w-full h-full object-contain p-2">
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
        
                        <!-- Main image -->
                        <div class="aspect-square w-full h-[484px] max-w-[484px] bg-white rounded-xl overflow-hidden flex items-center justify-center border border-gray-200 p-4">
                            <img id="main-product-image" src="${mainImageURL}" alt="${product.name}" class="w-full h-full object-contain">
                        </div>
                    </div>
                </div>

                <!-- Right side: Product details -->

                
                <div>
                    <h1 class="text-3xl font-bold text-black mb-4">${product.name}</h1>
                    <div class="mb-6">${priceDisplay}</div>
                    
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-2 text-black">Pershkrimi</h3>
                        <p class="text-gray-700 leading-relaxed">${product.description || 'Nuk ka pershkrim te disponueshem.'}</p>
                    </div>
                    
                    ${specsHTML}
                    
                    <div class="flex space-x-4 mt-8">
                        <button onclick="toggleWishlist(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price}, '${mainImageURL}')" 
                                class="border-2 border-red-600 text-red-600 px-6 py-3 rounded-lg hover:bg-red-50 transition-colors flex items-center space-x-2 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                            <span>Wishlist</span>
                        </button>
                        <button onclick="addToCart(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.discount_price || product.price}, '${mainImageURL}')" 
                                class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.2 6h12.8M10 19a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z"/>
                            </svg>
                            <span>Shto ne Shporte</span>
                        </button>
                    </div>
                </div>
            </div>
            
            ${product.related && product.related.length > 0 ? `
                <div class="mt-16">
                    <h3 class="text-2xl font-bold text-black mb-6">Produkte te Ngjashme</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                        ${product.related.map(r => {
                            const rImageURL = r.main_image || '/static/uploads/default.png';
                            const rPriceDisplay = r.discount_price && r.discount_price < r.price
                                ? `<div class="flex items-center space-x-2">
                                     <p class="text-red-700 font-semibold">${formatPrice(r.discount_price)}</p>
                                     <p class="text-xs text-gray-500 line-through">${formatPrice(r.price)}</p>
                                   </div>`
                                : `<p class="text-red-700 font-semibold">${formatPrice(r.price)}</p>`;
                            
                            return `
                                <div onclick="showProductDetail(${r.id})" class="cursor-pointer border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow bg-white">
                                    <div class="aspect-square bg-white rounded-lg overflow-hidden mb-3">
                                        <img src="${rImageURL}" class="w-full h-full object-contain">
                                    </div>
                                    <h4 class="font-semibold text-black mb-2 text-sm text-center min-h-[40px]">${r.name}</h4>
                                    ${rPriceDisplay}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
        `;
        
        previousPage = currentPage;
        currentPage = 'product-detail';
        window.history.pushState({ page: 'product-detail', productId: productId }, '', `/#product/${productId}`);
    } catch (error) {
        console.error('‚ùå Failed to load product detail:', error);
        showNotification('Failed to load product details', 'error');
    }
}

// ============================================
// CART FUNCTIONALITY
// ============================================
function loadCartFromStorage() {
    const stored = localStorage.getItem('auto_adeal_cart');
    if (stored) {
        try {
            cartItems = JSON.parse(stored);
        } catch (e) {
            cartItems = [];
        }
    }
}

function saveCartToStorage() {
    localStorage.setItem('auto_adeal_cart', JSON.stringify(cartItems));
}

function addToCart(productId, productName, productPrice, productImage) {
    // Check if already in cart
    const existingItem = cartItems.find(item => item.productId === productId);
    
    if (existingItem) {
        existingItem.quantity += 1;
        showNotification('Updated quantity in cart', 'success');
    } else {
        cartItems.push({
            productId,
            productName,
            productPrice,
            productImage,
            quantity: 1
        });
        showNotification('Added to cart!', 'success');
    }
    
    saveCartToStorage();
    updateCartCount();
    
    // Re-render if on cart page
    if (currentPage === 'cart') {
        loadCartPage();
    }
    
    // Re-render product cards to show "Added" state
    if (currentPage === 'home' || currentPage.includes('subcategory')) {
        const currentProducts = document.getElementById('products-container').children;
        // Just update the button text for this product
        // (Full re-render would reset scroll position)
    }
}

function removeFromCart(productId) {
    cartItems = cartItems.filter(item => item.productId !== productId);
    saveCartToStorage();
    updateCartCount();
    loadCartPage();
    showNotification('Removed from cart', 'success');
}

function updateCartQuantity(productId, newQuantity) {
    if (newQuantity <= 0) {
        removeFromCart(productId);
        return;
    }
    
    const item = cartItems.find(i => i.productId === productId);
    if (item) {
        item.quantity = newQuantity;
        saveCartToStorage();
        loadCartPage();
    }
}

function updateCartCount() {
    document.getElementById('cart-count').textContent = cartItems.length;
}

function loadCartPage() {
    const cartContent = document.getElementById('cart-content');
    
    if (cartItems.length === 0) {
        cartContent.innerHTML = `
            <div class="text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 mx-auto mb-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.2 6h12.8M10 19a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z"/>
                </svg>
                <h2 class="text-2xl font-bold text-black mb-2">Your cart is empty</h2>
                <p class="text-gray-600 mb-6">Add some products to get started!</p>
                <button onclick="showPage('home'); loadPopularProducts();" class="bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700 transition-colors">
                    Start Shopping
                </button>
            </div>
        `;
        return;
    }
    
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    
    cartContent.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-black">Cart Items (${cartItems.length})</h2>
                    </div>
                    <div class="divide-y divide-gray-200">
                        ${cartItems.map(item => `
                            <div class="p-6 flex items-center space-x-4" data-product-id="${item.productId}">
                                <img src="${item.productImage}" class="w-20 h-20 object-contain rounded">
                                <div class="flex-1">
                                    <h3 class="font-bold text-black">${item.productName}</h3>
                                    <p class="text-red-600 font-bold">${formatPrice(item.productPrice)}</p>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <button onclick="updateCartQuantity(${item.productId}, ${item.quantity - 1})" 
                                            class="w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">-</button>
                                    <span class="w-12 text-center font-medium">${item.quantity}</span>
                                    <button onclick="updateCartQuantity(${item.productId}, ${item.quantity + 1})" 
                                            class="w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">+</button>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-black">${formatPrice(item.productPrice * item.quantity)}</p>
                                    <button onclick="removeFromCart(${item.productId})" 
                                            class="text-red-600 hover:text-red-700 text-sm mt-1">Remove</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                <div class="bg-white border border-gray-200 rounded-lg p-6 sticky top-6">
                    <h2 class="text-xl font-bold text-black mb-4">Order Summary</h2>
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal (${cartItems.length} items)</span>
                            <span class="font-medium text-black">${formatPrice(subtotal)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Shipping</span>
                            <span class="text-gray-600">Calculated at checkout</span>
                        </div>
                        <hr class="my-3">
                        <div class="flex justify-between text-lg">
                            <span class="font-bold text-black">Total</span>
                            <span class="font-bold text-black">${formatPrice(subtotal)}</span>
                        </div>
                    </div>
                    <button onclick="showPage('checkout')" 
                            class="w-full bg-red-600 text-white py-3 rounded hover:bg-red-700 transition-colors mb-3">
                        Proceed to Checkout
                    </button>
                    <button onclick="showPage('home'); loadPopularProducts();" 
                            class="w-full bg-gray-200 text-black py-3 rounded hover:bg-gray-300 transition-colors">
                        Continue Shopping
                    </button>
                </div>
            </div>
        </div>
    `;
}

// ============================================
// WISHLIST FUNCTIONALITY
// ============================================
function loadWishlistFromStorage() {
    const stored = localStorage.getItem('auto_adeal_wishlist');
    if (stored) {
        try {
            wishlistItems = JSON.parse(stored);
        } catch (e) {
            wishlistItems = [];
        }
    }
}

function saveWishlistToStorage() {
    localStorage.setItem('auto_adeal_wishlist', JSON.stringify(wishlistItems));
}

function toggleWishlist(productId, productName, productPrice, productImage) {
    const existingIndex = wishlistItems.findIndex(item => item.productId === productId);
    
    if (existingIndex !== -1) {
        wishlistItems.splice(existingIndex, 1);
        showNotification('Removed from wishlist', 'success');
    } else {
        wishlistItems.push({
            productId,
            productName,
            productPrice,
            productImage
        });
        showNotification('Added to wishlist!', 'success');
    }
    
    saveWishlistToStorage();
    updateWishlistCount();
    
    // Re-render if on wishlist page
    if (currentPage === 'wishlist') {
        loadWishlistPage();
    }
}

function updateWishlistCount() {
    document.getElementById('wishlist-count').textContent = wishlistItems.length;
}

function loadWishlistPage() {
    const grid = document.getElementById('wishlist-grid');
    grid.innerHTML = '';
    
    if (wishlistItems.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 mx-auto mb-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
                <h2 class="text-2xl font-bold text-black mb-2">Your wishlist is empty</h2>
                <p class="text-gray-600 mb-6">Save your favorite products here!</p>
                <button onclick="showPage('home'); loadPopularProducts();" class="bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700 transition-colors">
                    Start Shopping
                </button>
            </div>
        `;
        return;
    }
    
    wishlistItems.forEach(item => {
        const card = document.createElement('div');
        card.classList.add('bg-white', 'border', 'border-gray-200', 'rounded-xl', 
                          'p-4', 'shadow-sm', 'hover:shadow-md', 'transition-shadow');
        
        const isInCart = cartItems.some(cartItem => cartItem.productId === item.productId);
        
        card.innerHTML = `
            <div onclick="showProductDetail(${item.productId})" class="cursor-pointer">
                <img src="${item.productImage}" alt="${item.productName}" class="w-full h-40 object-contain mb-4 rounded">
                <h4 class="font-semibold text-black mb-2">${item.productName}</h4>
                <p class="text-red-700 font-bold text-lg mb-4">${formatPrice(item.productPrice)}</p>
            </div>
            
            <div class="flex space-x-2">
                <button
                    onclick="event.stopPropagation(); toggleWishlist(${item.productId}, '${item.productName}', ${item.productPrice}, '${item.productImage}')"
                    class="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700 transition-colors"
                >
                    Remove
                </button>
                <button
                    onclick="event.stopPropagation(); addToCart(${item.productId}, '${item.productName}', ${item.productPrice}, '${item.productImage}')"
                    class="flex-1 ${isInCart ? 'bg-green-600' : 'bg-gray-600'} text-white py-2 rounded hover:bg-gray-700 transition-colors"
                >
                    ${isInCart ? '‚úì In Cart' : 'üõí Add to Cart'}
                </button>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

// ============================================
// CHECKOUT
// ============================================
function loadCheckoutSummary() {
    const summary = document.getElementById('checkout-summary');
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    
    summary.innerHTML = `
        <div class="space-y-3">
            ${cartItems.map(item => `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-medium text-black">${item.productName}</p>
                        <p class="text-gray-600 text-sm">Qty: ${item.quantity}</p>
                    </div>
                    <p class="font-medium text-black">${formatPrice(item.productPrice * item.quantity)}</p>
                </div>
            `).join('')}
            
            <hr class="my-3">
            
            <div class="flex justify-between">
                <p class="font-medium text-black">Subtotal:</p>
                <p class="font-medium text-black">${formatPrice(subtotal)}</p>
            </div>
            
            <div class="flex justify-between">
                <p class="font-medium text-black">Shipping:</p>
                <p class="font-medium text-black" id="shipping-cost">Select country</p>
            </div>
            
            <hr class="my-3">
            
            <div class="flex justify-between text-lg">
                <p class="font-bold text-black">Total:</p>
                <p class="font-bold text-black" id="total-cost">${formatPrice(subtotal)}</p>
            </div>
        </div>
    `;
}

function updateShipping() {
    const country = document.getElementById('checkout-country').value;
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    let shippingCost = 0;
    
    if (country === 'Albania') {
        shippingCost = currentCurrency === 'EUR' ? 3 : 300;
    } else if (country === 'Kosovo') {
        shippingCost = currentCurrency === 'EUR' ? 7 : 700;
    }
    
    document.getElementById('shipping-cost').textContent = shippingCost > 0 ? formatPrice(shippingCost) : 'Select country';
    document.getElementById('total-cost').textContent = formatPrice(subtotal + shippingCost);
}

function processOrder(event) {
    event.preventDefault();
    
    const name = document.getElementById('checkout-name').value;
    const phone = document.getElementById('checkout-phone').value;
    const country = document.getElementById('checkout-country').value;
    const city = document.getElementById('checkout-city').value;
    
    const subtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
    let shippingCost = 0;
    
    if (country === 'Albania') {
        shippingCost = currentCurrency === 'EUR' ? 3 : 300;
    } else if (country === 'Kosovo') {
        shippingCost = currentCurrency === 'EUR' ? 7 : 700;
    }
    
    const total = subtotal + shippingCost;
    
    // Store order (you can send this to backend later)
    const order = {
        orderName: name,
        orderPhone: phone,
        orderCountry: country,
        orderCity: city,
        orderTotal: total,
        orderItems: cartItems,
        orderDate: new Date().toISOString()
    };
    
    console.log('Order placed:', order);
    
    // Clear cart
    cartItems = [];
    saveCartToStorage();
    updateCartCount();
    
    showNotification('Order placed successfully! You will receive a call to confirm delivery.', 'success');
    showPage('home');
    loadPopularProducts();
}

// ============================================
// DYNAMIC FILTERS
// ============================================
let currentSubcategoryId = null;
let currentFilters = {};
let priceRange = { min: 0, max: 20000 };

// Predefined filter choices for Albanian specifications
const filterChoices = {
    'E pershtatshme per': ['Volkswagen', 'BMW', 'Audi', 'Mercedes-Benz', 'Toyota', 'Ford', 'Skoda', 'Porsche', 'SEAT', 'Opel', 'Fiat', 'Range Rover', 'Tesla', 'Hyundai', 'Cintroen', 'MINI', 'Honda', 'Peugeot', 'Renault', 'Nissan', 'Volvo', 'Mazda'],
    'Pozicioni': ['Para Majtas', 'Para Djathtas', 'Mbrapa Majtas', 'Mbrapa Djathtas', 'Set'],
    'Sasia': ['30ml', '50ml', '60ml'],
    'Pjesa': ['Mbulese', 'Koke', 'Set'],
    'Ngjyra': ['E zeze', 'E bardhe', 'Bezhe', 'Gri', 'Kafe'],
    'Lloji i Bazes': ['H7', 'H4', 'H1', 'H11', 'W5W', 'P21W'],
    'Lloji i Llampes': ['LED', 'Halogjen', 'Xenon'],
    'Perdorimi': ['Te Gjata', 'Te Shkurtra', 'Stopa', 'Sinjale', 'Drita Mjegulle', 'Drita te Brendshme'],
    'Ngjyra e Drites': ['E bardhe', 'E kuqe', 'Portokalli'],
    'Temperatura e Ngjyres': ['3000K', '4300K', '6000K'],
    'Prodhuesi': ['Castrol', 'Liqui Moly', 'Motul', 'Shell', 'Mobil', 'Valvoline', 'Amsoil', 'Motul', 'Tjeter'],
    'Kapaciteti': ['1L', '2L', '4L', '5L+'],
    'Lloji i Motorit': ['Nafte', 'Benzine', 'Gaz', 'Hybrid'],
    'Lloji i Ftohesit': ['G11', 'G12', 'G12+', 'G13'],
    'Ngjyra e Ftohesit': ['E kuqe', 'Blu', 'Jeshile', 'Portokalli', 'Roze', 'E verdhe', 'Tjeter'],
    'Vleresimi DOT': ['DOT3', 'DOT4', 'DOT5', 'DOT5.1'],
    'Viscosity': ['5w30', '5w40', '0w40', '10w30', '75w80', '75w90', 'Tjeter'],
    'Materiali': ['Cope', 'Gomine', 'Lekure PU']
};

async function loadSubcategoryFilters(subcategoryId) {
    currentSubcategoryId = subcategoryId;
    currentFilters = {};
    priceRange = { min: 0, max: 20000 };
    
    try {
        const response = await fetch(`/api/subcategory/${subcategoryId}/specs`);
        const specs = await response.json();
        
        // Show filters section
        document.getElementById('categories-section').style.display = 'none';
        document.getElementById('filters-section').style.display = 'block';
        
        // Render filters
        const filtersContainer = document.getElementById('dynamic-filters');
        filtersContainer.innerHTML = '';
        
        // ALWAYS add price range filter first
        filtersContainer.appendChild(createPriceRangeFilter());
        
        // Add other filters from database
        specs.forEach(spec => {
            const filterDiv = document.createElement('div');
            filterDiv.classList.add('mb-4');
            
            const label = document.createElement('label');
            label.classList.add('block', 'text-sm', 'font-medium', 'text-black', 'mb-2');
            label.textContent = spec.name;
            filterDiv.appendChild(label);
            
            // Check if we have predefined choices for this spec
            const choices = filterChoices[spec.name] || spec.choices || [];
            
            if (choices.length > 0) {
                const select = document.createElement('select');
                select.classList.add('w-full', 'px-3', 'py-2', 'border', 'border-gray-300', 'rounded', 'text-black', 'text-sm');
                select.id = `filter-${spec.id}`;
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `Zgjedh ${spec.name}`;
                select.appendChild(defaultOption);
                
                choices.forEach(choice => {
                    const option = document.createElement('option');
                    const choiceValue = typeof choice === 'string' ? choice.trim() : choice;
                    option.value = choiceValue;
                    option.textContent = choiceValue;
                    select.appendChild(option);
                });
                
                filterDiv.appendChild(select);
            } else {
                // Fallback to text input if no choices defined
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `filter-${spec.id}`;
                input.placeholder = `Kerko sipas ${spec.name}`;
                input.classList.add('w-full', 'px-3', 'py-2', 'border', 'border-gray-300', 'rounded', 'text-black', 'text-sm');
                filterDiv.appendChild(input);
            }
            
            filtersContainer.appendChild(filterDiv);
        });
        
        // Initialize price slider
        initializePriceSlider();
        
    } catch (error) {
        console.error('‚ùå Failed to load filters:', error);
    }
}

function createPriceRangeFilter() {
    const filterDiv = document.createElement('div');
    filterDiv.classList.add('mb-6', 'pb-4', 'border-b', 'border-gray-200');
    
    filterDiv.innerHTML = `
        <label class="block text-sm font-medium text-black mb-3">Cmimi (ALL)</label>
        
        <!-- Slider Container -->
        <div class="relative h-2 bg-gray-200 rounded-full mb-4" id="price-slider">
            <div id="price-track" class="absolute h-2 bg-red-600 rounded-full"></div>
            <div id="min-thumb" class="absolute w-5 h-5 bg-red-600 border-2 border-white rounded-full cursor-pointer shadow-md" style="top: -6px;"></div>
            <div id="max-thumb" class="absolute w-5 h-5 bg-red-600 border-2 border-white rounded-full cursor-pointer shadow-md" style="top: -6px;"></div>
        </div>
        
        <!-- Input Fields -->
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="text-xs text-gray-600 mb-1 block">Nga:</label>
                <input type="number" id="min-price-input" value="0" min="0" max="20000" 
                       class="w-full px-3 py-2 border border-gray-300 rounded text-black text-sm">
            </div>
            <div>
                <label class="text-xs text-gray-600 mb-1 block">Deri:</label>
                <input type="number" id="max-price-input" value="20000" min="0" max="20000" 
                       class="w-full px-3 py-2 border border-gray-300 rounded text-black text-sm">
            </div>
        </div>
    `;
    
    return filterDiv;
}

function initializePriceSlider() {
    const slider = document.getElementById('price-slider');
    const track = document.getElementById('price-track');
    const minThumb = document.getElementById('min-thumb');
    const maxThumb = document.getElementById('max-thumb');
    const minInput = document.getElementById('min-price-input');
    const maxInput = document.getElementById('max-price-input');
    
    if (!slider || !track || !minThumb || !maxThumb) return;
    
    let isDragging = false;
    let activeThumb = null;
    
    function updateSlider() {
        const sliderWidth = slider.offsetWidth;
        const minPercent = (priceRange.min / 20000) * 100;
        const maxPercent = (priceRange.max / 20000) * 100;
        
        minThumb.style.left = `calc(${minPercent}% - 10px)`;
        maxThumb.style.left = `calc(${maxPercent}% - 10px)`;
        
        track.style.left = `${minPercent}%`;
        track.style.width = `${maxPercent - minPercent}%`;
        
        minInput.value = priceRange.min;
        maxInput.value = priceRange.max;
    }
    
    function handleMouseDown(e, thumb) {
        isDragging = true;
        activeThumb = thumb;
        e.preventDefault();
        document.body.style.userSelect = 'none';
    }
    
    function handleMouseMove(e) {
        if (!isDragging || !activeThumb) return;
        
        const rect = slider.getBoundingClientRect();
        const percent = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
        const value = Math.round((percent / 100) * 20000);
        
        if (activeThumb === minThumb) {
            priceRange.min = Math.min(value, priceRange.max - 100);
        } else {
            priceRange.max = Math.max(value, priceRange.min + 100);
        }
        
        updateSlider();
    }
    
    function handleMouseUp() {
        isDragging = false;
        activeThumb = null;
        document.body.style.userSelect = '';
    }
    
    function handleTouchStart(e, thumb) {
        handleMouseDown(e.touches[0], thumb);
    }
    
    function handleTouchMove(e) {
        if (!isDragging) return;
        e.preventDefault();
        handleMouseMove(e.touches[0]);
    }
    
    // Mouse events
    minThumb.addEventListener('mousedown', (e) => handleMouseDown(e, minThumb));
    maxThumb.addEventListener('mousedown', (e) => handleMouseDown(e, maxThumb));
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    
    // Touch events for mobile
    minThumb.addEventListener('touchstart', (e) => handleTouchStart(e, minThumb));
    maxThumb.addEventListener('touchstart', (e) => handleTouchStart(e, maxThumb));
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleMouseUp);
    
    // Input field handlers
    minInput.addEventListener('input', (e) => {
        const value = parseInt(e.target.value) || 0;
        priceRange.min = Math.max(0, Math.min(value, priceRange.max - 100));
        updateSlider();
    });
    
    maxInput.addEventListener('input', (e) => {
        const value = parseInt(e.target.value) || 20000;
        priceRange.max = Math.min(20000, Math.max(value, priceRange.min + 100));
        updateSlider();
    });
    
    // Initialize slider position
    updateSlider();
}

function showCategories() {
    document.getElementById('categories-section').style.display = 'block';
    document.getElementById('filters-section').style.display = 'none';
    currentSubcategoryId = null;
}

async function applyFilters() {
    if (!currentSubcategoryId) return;
    
    // Get all filter values
    const filterInputs = document.querySelectorAll('#dynamic-filters select, #dynamic-filters input[type="text"]');
    currentFilters = {};
    
    filterInputs.forEach(input => {
        if (input.value && input.id.startsWith('filter-')) {
            const specId = input.id.replace('filter-', '');
            currentFilters[specId] = input.value.toLowerCase();
        }
    });
    
    // Fetch products
    const response = await fetch(`/api/subcategory/${currentSubcategoryId}/products`);
    let products = await response.json();
    
    // Apply price range filter
    products = products.filter(product => {
        const price = product.discount_price || product.price;
        return price >= priceRange.min && price <= priceRange.max;
    });
    
    // Apply spec filters
    if (Object.keys(currentFilters).length > 0) {
        products = products.filter(product => {
            for (const [specId, filterValue] of Object.entries(currentFilters)) {
                const filterElement = document.querySelector(`#filter-${specId}`);
                if (!filterElement || !filterElement.previousElementSibling) continue;
                
                const specName = filterElement.previousElementSibling.textContent;
                const productSpecValue = product.specs[specName];
                
                if (!productSpecValue || !productSpecValue.toLowerCase().includes(filterValue)) {
                    return false;
                }
            }
            return true;
        });
    }
    
    renderProducts(products);
    showNotification(`${products.length} produkte u gjeten`, 'success');
}

// ============================================
// PAGE NAVIGATION
// ============================================
function showPage(pageId, addToHistory = true) {
    // Hide all pages
    document.querySelectorAll('.page-content').forEach(page => {
        page.style.display = 'none';
    });
    
    // Show/hide sidebar
    const sidebar = document.getElementById('sidebar');
    if (['special-offers', 'brands', 'contact', 'checkout', 'wishlist', 'cart'].includes(pageId)) {
        sidebar.style.display = 'none';
    } else {
        sidebar.style.display = 'block';
    }
    
    previousPage = currentPage;
    currentPage = pageId;
    
    // Add to browser history
    if (addToHistory) {
        const url = pageId === 'home' ? '/' : `/#${pageId}`;
        window.history.pushState({ page: pageId }, '', url);
    }
    
    // Show selected page
    switch(pageId) {
        case 'home':
            document.getElementById('home-page').style.display = 'block';
            showCategories();
            break;
        case 'special-offers':
            document.getElementById('special-offers-page').style.display = 'block';
            loadSpecialOffers();
            break;
        case 'brands':
            document.getElementById('brands-page').style.display = 'block';
            loadBrandsPage();
            break;
        case 'contact':
            document.getElementById('contact-page').style.display = 'block';
            break;
        case 'checkout':
            if (cartItems.length === 0) {
                showNotification('Your cart is empty', 'error');
                showPage('cart');
                return;
            }
            document.getElementById('checkout-page').style.display = 'block';
            loadCheckoutSummary();
            break;
        case 'cart':
            document.getElementById('cart-page').style.display = 'block';
            loadCartPage();
            break;
        case 'wishlist':
            document.getElementById('wishlist-page').style.display = 'block';
            loadWishlistPage();
            break;
    }
}

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    if (event.state && event.state.page) {
        showPage(event.state.page, false);
    } else {
        // If no state, check URL hash
        const hash = window.location.hash.substring(1);
        if (hash) {
            showPage(hash, false);
        } else {
            showPage('home', false);
        }
    }
});

// Handle page load with hash
window.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash.substring(1);
    if (hash) {
        showPage(hash, false);
    } else {
        // Set initial history state
        window.history.replaceState({ page: 'home' }, '', '/');
    }
});

function goBack() {
    showPage(previousPage);
}

function showWishlist() {
    showPage('wishlist');
}

// ============================================
// SEARCH
// ============================================
async function performSearch() {
    const query = document.getElementById('search-input').value.trim();
    
    if (!query) {
        showNotification('Please enter a search term', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const products = await response.json();
        
        // Split search query into individual words
        const searchWords = query.toLowerCase().split(/\s+/).filter(word => word.length > 0);
        
        // Filter products that match ANY of the search words
        const filteredProducts = products.filter(product => {
            // Create searchable text from product
            const searchableText = [
                product.name,
                product.description,
                product.tags || '',
                ...Object.values(product.specs || {})
            ].join(' ').toLowerCase();
            
            // Check if ANY search word appears in the searchable text
            return searchWords.some(word => searchableText.includes(word));
        });
        
        document.getElementById('products-title').textContent = `Search results for "${query}"`;
        renderProducts(filteredProducts);
        
        showPage('home');
        showNotification(`Found ${filteredProducts.length} products`, 'success');
    } catch (error) {
        console.error('‚ùå Search failed:', error);
        showNotification('Search failed', 'error');
    }
}

// Enter key support for search
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
});

// ============================================
// UTILITY FUNCTIONS
// ============================================
function formatPrice(price) {
    return `${Math.round(price)} ALL`;
}

function showNotification(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function setupScrollToTop() {
    const scrollBtn = document.querySelector('.scroll-to-top');
    
    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
            scrollBtn.style.display = 'block';
        } else {
            scrollBtn.style.display = 'none';
        }
    });
}

function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ============================================
// INITIALIZE ON PAGE LOAD
// ============================================
document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>